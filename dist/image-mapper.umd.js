(function(K,ht){typeof exports=="object"&&typeof module<"u"?ht(exports):typeof define=="function"&&define.amd?define(["exports"],ht):(K=typeof globalThis<"u"?globalThis:K||self,ht(K["image-mapper"]={}))})(this,function(K){"use strict";const ht=window||void 0,Z=ht.window.document,it="http://www.w3.org/2000/svg",me=new RegExp(/^data-[a-zA-Z]+/),W=function(n,t,e){[n].flat().forEach(i=>{t.split(" ").forEach(r=>{i.addEventListener(r,e,{passive:!1})})})},we=function(n,t,e){[n].flat().forEach(i=>{t.split(" ").forEach(r=>{i.removeEventListener(r,e)})})},cn={fill:"rgb(102, 102, 102)",stroke:"rgb(51, 51, 51)",cursor:"pointer"},ln={off:{"stroke-width":"1",opacity:.5},on:{"stroke-width":"2",opacity:.6}},dn={off:{"stroke-dasharray":"none","stroke-linejoin":"miter"},on:{"stroke-dasharray":"4 3","stroke-linejoin":"round"}},fn={fill:"rgb(255, 255, 255)",stroke:"rgb(51, 51, 51)","stroke-width":"1",opacity:.3,cursor:"pointer"},vn={opacity:.6},pn=()=>({component:Object.assign({},cn),componentHover:Object.assign({},ln),componentSelect:Object.assign({},dn),handle:Object.assign({},fn),handleHover:Object.assign({},vn)}),X=(n,t)=>Object.entries(t).forEach(([e,i])=>n.setAttribute(e,String(i))),Qt=(n,t,e)=>{W(n,"mouseenter touchstart",()=>X(n,e)),W(n,"mouseleave touchend touchleave",()=>X(n,t))};class ${constructor(t,e,i,r){this.x=t,this.y=e,this.moveHandler=i,this.element=Z.createElementNS(it,"circle"),this.element.setAttribute("cx",String(t)),this.element.setAttribute("cy",String(e)),this.element.setAttribute("r",String(5)),this.element.setAttribute("visibility","hidden"),this.isFrozen=r!==void 0?!!r:!1}freeze(t){return this.isFrozen=t!==void 0?!!t:!0,this.isFrozen&&this.setVisible(!1),this}setAttrX(t){return this.element.setAttribute("cx",String(t)),this}delete(){this.element.remove()}setAttrY(t){return this.element.setAttribute("cy",String(t)),this}move(t,e){return this.moveHandler(t,e),this}setVisible(t){return t=t!==void 0?!!t:!0,this.element.setAttribute("visibility",t?"visible":"hidden"),this}setStyle(t,e){return X(this.element,t),Qt(this.element,t,e),this}}/*! *****************************************************************************
  Copyright (c) Microsoft Corporation.

  Permission to use, copy, modify, and/or distribute this software for any
  purpose with or without fee is hereby granted.

  THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
  REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
  AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
  INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
  LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
  OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
  PERFORMANCE OF THIS SOFTWARE.
  ***************************************************************************** */var f=function(){return f=Object.assign||function(t){for(var e,i=1,r=arguments.length;i<r;i++){e=arguments[i];for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s])}return t},f.apply(this,arguments)};function te(n,t){var e={};for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&t.indexOf(i)<0&&(e[i]=n[i]);if(n!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,i=Object.getOwnPropertySymbols(n);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(n,i[r])&&(e[i[r]]=n[i[r]]);return e}function E(n){var t=typeof Symbol=="function"&&Symbol.iterator,e=t&&n[t],i=0;if(e)return e.call(n);if(n&&typeof n.length=="number")return{next:function(){return n&&i>=n.length&&(n=void 0),{value:n&&n[i++],done:!n}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function M(n,t){var e=typeof Symbol=="function"&&n[Symbol.iterator];if(!e)return n;var i=e.call(n),r,s=[],o;try{for(;(t===void 0||t-- >0)&&!(r=i.next()).done;)s.push(r.value)}catch(a){o={error:a}}finally{try{r&&!r.done&&(e=i.return)&&e.call(i)}finally{if(o)throw o.error}}return s}function P(n,t,e){if(e||arguments.length===2)for(var i=0,r=t.length,s;i<r;i++)(s||!(i in t))&&(s||(s=Array.prototype.slice.call(t,0,i)),s[i]=t[i]);return n.concat(s||Array.prototype.slice.call(t))}var T;(function(n){n.Start="xstate.start",n.Stop="xstate.stop",n.Raise="xstate.raise",n.Send="xstate.send",n.Cancel="xstate.cancel",n.NullEvent="",n.Assign="xstate.assign",n.After="xstate.after",n.DoneState="done.state",n.DoneInvoke="done.invoke",n.Log="xstate.log",n.Init="xstate.init",n.Invoke="xstate.invoke",n.ErrorExecution="error.execution",n.ErrorCommunication="error.communication",n.ErrorPlatform="error.platform",n.ErrorCustom="xstate.error",n.Update="xstate.update",n.Pure="xstate.pure",n.Choose="xstate.choose"})(T||(T={}));var tt;(function(n){n.Parent="#_parent",n.Internal="#_internal"})(tt||(tt={}));var It=T.Start,Lt=T.Stop,ut=T.Raise,bt=T.Send,ee=T.Cancel,Se=T.NullEvent,jt=T.Assign,yn=T.After,gn=T.DoneState,Rt=T.Log,be=T.Init,kt=T.Invoke,mn=T.ErrorExecution,ne=T.ErrorPlatform,ie=T.ErrorCustom,zt=T.Update,xe=T.Choose,Ee=T.Pure;const wn=Object.freeze(Object.defineProperty({__proto__:null,after:yn,assign:jt,cancel:ee,choose:xe,doneState:gn,error:ie,errorExecution:mn,errorPlatform:ne,init:be,invoke:kt,log:Rt,nullEvent:Se,pure:Ee,raise:ut,send:bt,start:It,stop:Lt,update:zt},Symbol.toStringTag,{value:"Module"}));var Oe=".",Me={},re="xstate.guard",Sn="",R=process.env.NODE_ENV==="production",Ft;function se(n,t,e){e===void 0&&(e=Oe);var i=xt(n,e),r=xt(t,e);return C(r)?C(i)?r===i:!1:C(i)?i in r:Object.keys(i).every(function(s){return s in r?se(i[s],r[s]):!1})}function Ae(n){try{return C(n)||typeof n=="number"?"".concat(n):n.type}catch{throw new Error("Events must be strings or objects with a string event.type property.")}}function oe(n,t){try{return ct(n)?n:n.toString().split(t)}catch{throw new Error("'".concat(n,"' is not a valid state path."))}}function bn(n){return typeof n=="object"&&"value"in n&&"context"in n&&"event"in n&&"_event"in n}function xt(n,t){if(bn(n))return n.value;if(ct(n))return Ht(n);if(typeof n!="string")return n;var e=oe(n,t);return Ht(e)}function Ht(n){if(n.length===1)return n[0];for(var t={},e=t,i=0;i<n.length-1;i++)i===n.length-2?e[n[i]]=n[i+1]:(e[n[i]]={},e=e[n[i]]);return t}function Et(n,t){for(var e={},i=Object.keys(n),r=0;r<i.length;r++){var s=i[r];e[s]=t(n[s],s,n,r)}return e}function Ce(n,t,e){var i,r,s={};try{for(var o=E(Object.keys(n)),a=o.next();!a.done;a=o.next()){var h=a.value,u=n[h];e(u)&&(s[h]=t(u,h,n))}}catch(c){i={error:c}}finally{try{a&&!a.done&&(r=o.return)&&r.call(o)}finally{if(i)throw i.error}}return s}var xn=function(n){return function(t){var e,i,r=t;try{for(var s=E(n),o=s.next();!o.done;o=s.next()){var a=o.value;r=r[a]}}catch(h){e={error:h}}finally{try{o&&!o.done&&(i=s.return)&&i.call(s)}finally{if(e)throw e.error}}return r}};function En(n,t){return function(e){var i,r,s=e;try{for(var o=E(n),a=o.next();!a.done;a=o.next()){var h=a.value;s=s[t][h]}}catch(u){i={error:u}}finally{try{a&&!a.done&&(r=o.return)&&r.call(o)}finally{if(i)throw i.error}}return s}}function Yt(n){if(!n)return[[]];if(C(n))return[[n]];var t=j(Object.keys(n).map(function(e){var i=n[e];return typeof i!="string"&&(!i||!Object.keys(i).length)?[[e]]:Yt(n[e]).map(function(r){return[e].concat(r)})}));return t}function j(n){var t;return(t=[]).concat.apply(t,P([],M(n),!1))}function De(n){return ct(n)?n:[n]}function V(n){return n===void 0?[]:De(n)}function Ut(n,t,e){var i,r;if(A(n))return n(t,e.data);var s={};try{for(var o=E(Object.keys(n)),a=o.next();!a.done;a=o.next()){var h=a.value,u=n[h];A(u)?s[h]=u(t,e.data):s[h]=u}}catch(c){i={error:c}}finally{try{a&&!a.done&&(r=o.return)&&r.call(o)}finally{if(i)throw i.error}}return s}function On(n){return/^(done|error)\./.test(n)}function Te(n){return!!(n instanceof Promise||n!==null&&(A(n)||typeof n=="object")&&A(n.then))}function Mn(n){return n!==null&&typeof n=="object"&&"transition"in n&&typeof n.transition=="function"}function An(n,t){var e,i,r=M([[],[]],2),s=r[0],o=r[1];try{for(var a=E(n),h=a.next();!h.done;h=a.next()){var u=h.value;t(u)?s.push(u):o.push(u)}}catch(c){e={error:c}}finally{try{h&&!h.done&&(i=a.return)&&i.call(a)}finally{if(e)throw e.error}}return[s,o]}function _e(n,t){return Et(n.states,function(e,i){if(e){var r=(C(t)?void 0:t[i])||(e?e.current:void 0);if(r)return{current:r,states:_e(e,r)}}})}function Cn(n,t){return{current:t,states:_e(n,t)}}function Ne(n,t,e,i){R||H(!!n,"Attempting to update undefined context");var r=n&&e.reduce(function(s,o){var a,h,u=o.assignment,c={state:i,action:o,_event:t},d={};if(A(u))d=u(s,t.data,c);else try{for(var l=E(Object.keys(u)),v=l.next();!v.done;v=l.next()){var y=v.value,p=u[y];d[y]=A(p)?p(s,t.data,c):p}}catch(S){a={error:S}}finally{try{v&&!v.done&&(h=l.return)&&h.call(l)}finally{if(a)throw a.error}}return Object.assign({},s,d)},n);return r}var H=function(){};R||(H=function(n,t){var e=n instanceof Error?n:void 0;if(!(!e&&n)&&console!==void 0){var i=["Warning: ".concat(t)];e&&i.push(e),console.warn.apply(console,i)}});function ct(n){return Array.isArray(n)}function A(n){return typeof n=="function"}function C(n){return typeof n=="string"}function Pe(n,t){if(n)return C(n)?{type:re,name:n,predicate:t?t[n]:void 0}:A(n)?{type:re,name:n.name,predicate:n}:n}function Dn(n){try{return"subscribe"in n&&A(n.subscribe)}catch{return!1}}var et=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}();Ft={},Ft[et]=function(){return this},Ft[Symbol.observable]=function(){return this};function rt(n){return!!n&&"__xstatenode"in n}function Tn(n){return!!n&&typeof n.send=="function"}function Wt(n,t){return C(n)||typeof n=="number"?f({type:n},t):n}function Y(n,t){if(!C(n)&&"$$type"in n&&n.$$type==="scxml")return n;var e=Wt(n);return f({name:e.type,data:e,$$type:"scxml",type:"external"},t)}function lt(n,t){var e=De(t).map(function(i){return typeof i>"u"||typeof i=="string"||rt(i)?{target:i,event:n}:f(f({},i),{event:n})});return e}function _n(n){if(!(n===void 0||n===Sn))return V(n)}function Nn(n,t,e){if(!R){var i=n.stack?" Stacktrace was '".concat(n.stack,"'"):"";if(n===t)console.error("Missing onError handler for invocation '".concat(e,"', error was '").concat(n,"'.").concat(i));else{var r=t.stack?" Stacktrace was '".concat(t.stack,"'"):"";console.error("Missing onError handler and/or unhandled exception/promise rejection for invocation '".concat(e,"'. ")+"Original error: '".concat(n,"'. ").concat(i," Current error is '").concat(t,"'.").concat(r))}}}function Ie(n,t,e,i,r){var s=n.options.guards,o={state:r,cond:t,_event:i};if(t.type===re)return((s==null?void 0:s[t.name])||t.predicate)(e,i.data,o);var a=s==null?void 0:s[t.type];if(!a)throw new Error("Guard '".concat(t.type,"' is not implemented on machine '").concat(n.id,"'."));return a(e,i.data,o)}function Le(n){return typeof n=="string"?{type:n}:n}function Xt(n,t,e){var i=function(){},r=typeof n=="object",s=r?n:null;return{next:((r?n.next:n)||i).bind(s),error:((r?n.error:t)||i).bind(s),complete:((r?n.complete:e)||i).bind(s)}}function $t(n,t){return"".concat(n,":invocation[").concat(t,"]")}function ae(n){return(n.type===ut||n.type===bt&&n.to===tt.Internal)&&typeof n.delay!="number"}var st=Y({type:be});function Vt(n,t){return t&&t[n]||void 0}function dt(n,t){var e;if(C(n)||typeof n=="number"){var i=Vt(n,t);A(i)?e={type:n,exec:i}:i?e=i:e={type:n,exec:void 0}}else if(A(n))e={type:n.name||n.toString(),exec:n};else{var i=Vt(n.type,t);if(A(i))e=f(f({},n),{exec:i});else if(i){var r=i.type||n.type;e=f(f(f({},i),n),{type:r})}else e=n}return e}var Q=function(n,t){if(!n)return[];var e=ct(n)?n:[n];return e.map(function(i){return dt(i,t)})};function Bt(n){var t=dt(n);return f(f({id:C(n)?n:t.id},t),{type:t.type})}function je(n,t){return{type:ut,event:typeof n=="function"?n:Wt(n),delay:t?t.delay:void 0,id:t==null?void 0:t.id}}function Re(n,t,e,i){var r={_event:e},s=Y(A(n.event)?n.event(t,e.data,r):n.event),o;if(C(n.delay)){var a=i&&i[n.delay];o=A(a)?a(t,e.data,r):a}else o=A(n.delay)?n.delay(t,e.data,r):n.delay;return f(f({},n),{type:ut,_event:s,delay:o})}function ot(n,t){return{to:t?t.to:void 0,type:bt,event:A(n)?n:Wt(n),delay:t?t.delay:void 0,id:t&&t.id!==void 0?t.id:A(n)?n.name:Ae(n)}}function ke(n,t,e,i){var r={_event:e},s=Y(A(n.event)?n.event(t,e.data,r):n.event),o;if(C(n.delay)){var a=i&&i[n.delay];o=A(a)?a(t,e.data,r):a}else o=A(n.delay)?n.delay(t,e.data,r):n.delay;var h=A(n.to)?n.to(t,e.data,r):n.to;return f(f({},n),{to:h,_event:s,event:s.data,delay:o})}function he(n,t){return ot(n,f(f({},t),{to:tt.Parent}))}function Pn(n,t,e){return ot(t,f(f({},e),{to:n}))}function In(){return he(zt)}function Ln(n,t){return ot(n,f(f({},t),{to:function(e,i,r){var s=r._event;return s.origin}}))}var jn=function(n,t){return{context:n,event:t}};function Rn(n,t){return n===void 0&&(n=jn),{type:Rt,label:t,expr:n}}var ze=function(n,t,e){return f(f({},n),{value:C(n.expr)?n.expr:n.expr(t,e.data,{_event:e})})},Fe=function(n){return{type:ee,sendId:n}};function He(n){var t=Bt(n);return{type:T.Start,activity:t,exec:void 0}}function Ye(n){var t=A(n)?n:Bt(n);return{type:T.Stop,activity:t,exec:void 0}}function Ue(n,t,e){var i=A(n.activity)?n.activity(t,e.data):n.activity,r=typeof i=="string"?{id:i}:i,s={type:T.Stop,activity:r};return s}var We=function(n){return{type:jt,assignment:n}};function kn(n){return typeof n=="object"&&"type"in n}function Xe(n,t){var e=t?"#".concat(t):"";return"".concat(T.After,"(").concat(n,")").concat(e)}function Ot(n,t){var e="".concat(T.DoneState,".").concat(n),i={type:e,data:t};return i.toString=function(){return e},i}function Mt(n,t){var e="".concat(T.DoneInvoke,".").concat(n),i={type:e,data:t};return i.toString=function(){return e},i}function ft(n,t){var e="".concat(T.ErrorPlatform,".").concat(n),i={type:e,data:t};return i.toString=function(){return e},i}function zn(n){return{type:T.Pure,get:n}}function Fn(n,t){if(!R&&(!n||typeof n=="function")){var e=n;n=function(){for(var i=[],r=0;r<arguments.length;r++)i[r]=arguments[r];var s=typeof e=="function"?e.apply(void 0,P([],M(i),!1)):e;if(!s)throw new Error("Attempted to forward event to undefined actor. This risks an infinite loop in the sender.");return s}}return ot(function(i,r){return r},f(f({},t),{to:n}))}function Hn(n,t){return he(function(e,i,r){return{type:ie,data:A(n)?n(e,i,r):n}},f(f({},t),{to:tt.Parent}))}function Yn(n){return{type:T.Choose,conds:n}}var Un=function(n){var t,e,i=[];try{for(var r=E(n),s=r.next();!s.done;s=r.next())for(var o=s.value,a=0;a<o.actions.length;){if(o.actions[a].type===jt){i.push(o.actions[a]),o.actions.splice(a,1);continue}a++}}catch(h){t={error:h}}finally{try{s&&!s.done&&(e=r.return)&&e.call(r)}finally{if(t)throw t.error}}return i};function At(n,t,e,i,r,s,o){o===void 0&&(o=!1);var a=o?[]:Un(r),h=a.length?Ne(e,i,a,t):e,u=o?[e]:void 0,c=[];function d(y,p){var S;switch(p.type){case ut:{var m=Re(p,h,i,n.options.delays);return s&&typeof m.delay=="number"&&s(m,h,i),m}case bt:var g=ke(p,h,i,n.options.delays);if(!R){var w=p.delay;H(!C(w)||typeof g.delay=="number","No delay reference for delay expression '".concat(w,"' was found on machine '").concat(n.id,"'"))}return s&&g.to!==tt.Internal&&(y==="entry"?c.push(g):s(g,h,i)),g;case Rt:{var b=ze(p,h,i);return s==null||s(b,h,i),b}case xe:{var I=p,_=(S=I.conds.find(function(at){var nt=Pe(at.cond,n.options.guards);return!nt||Ie(n,nt,h,i,s?void 0:t)}))===null||S===void 0?void 0:S.actions;if(!_)return[];var D=M(At(n,t,h,i,[{type:y,actions:Q(V(_),n.options.actions)}],s,o),2),N=D[0],O=D[1];return h=O,u==null||u.push(h),N}case Ee:{var _=p.get(h,i.data);if(!_)return[];var k=M(At(n,t,h,i,[{type:y,actions:Q(V(_),n.options.actions)}],s,o),2),x=k[0],L=k[1];return h=L,u==null||u.push(h),x}case Lt:{var b=Ue(p,h,i);return s==null||s(b,e,i),b}case jt:{h=Ne(h,i,[p],s?void 0:t),u==null||u.push(h);break}default:var F=dt(p,n.options.actions),U=F.exec;if(s)s(F,h,i);else if(U&&u){var Pt=u.length-1,ge=f(f({},F),{exec:function(at){for(var nt=[],B=1;B<arguments.length;B++)nt[B-1]=arguments[B];U.apply(void 0,P([u[Pt]],M(nt),!1))}});F=ge}return F}}function l(y){var p,S,m=[];try{for(var g=E(y.actions),w=g.next();!w.done;w=g.next()){var b=w.value,I=d(y.type,b);I&&(m=m.concat(I))}}catch(_){p={error:_}}finally{try{w&&!w.done&&(S=g.return)&&S.call(g)}finally{if(p)throw p.error}}return c.forEach(function(_){s(_,h,i)}),c.length=0,m}var v=j(r.map(l));return[v,h]}const Wn=Object.freeze(Object.defineProperty({__proto__:null,actionTypes:wn,after:Xe,assign:We,cancel:Fe,choose:Yn,done:Ot,doneInvoke:Mt,error:ft,escalate:Hn,forwardTo:Fn,getActionFunction:Vt,initEvent:st,isActionObject:kn,log:Rn,pure:zn,raise:je,resolveActions:At,resolveLog:ze,resolveRaise:Re,resolveSend:ke,resolveStop:Ue,respond:Ln,send:ot,sendParent:he,sendTo:Pn,sendUpdate:In,start:He,stop:Ye,toActionObject:dt,toActionObjects:Q,toActivityDefinition:Bt},Symbol.toStringTag,{value:"Module"}));var $e=[],vt=function(n,t){$e.push(n);var e=t(n);return $e.pop(),e};function Ve(n){var t;return t={id:n,send:function(){},subscribe:function(){return{unsubscribe:function(){}}},getSnapshot:function(){},toJSON:function(){return{id:n}}},t[et]=function(){return this},t}function Xn(n,t,e,i){var r,s=Le(n.src),o=(r=t==null?void 0:t.options.services)===null||r===void 0?void 0:r[s.type],a=n.data?Ut(n.data,e,i):void 0,h=o?Be(o,n.id,a):Ve(n.id);return h.meta=n,h}function Be(n,t,e){var i=Ve(t);if(i.deferred=!0,rt(n)){var r=i.state=vt(void 0,function(){return(e?n.withContext(e):n).initialState});i.getSnapshot=function(){return r}}return i}function $n(n){try{return typeof n.send=="function"}catch{return!1}}function Vn(n){return $n(n)&&"id"in n}function Bn(n){var t;return f((t={subscribe:function(){return{unsubscribe:function(){}}},id:"anonymous",getSnapshot:function(){}},t[et]=function(){return this},t),n)}var Gt=function(n){return n.type==="atomic"||n.type==="final"};function Ge(n){return Object.keys(n.states).map(function(t){return n.states[t]})}function Ct(n){return Ge(n).filter(function(t){return t.type!=="history"})}function Je(n){var t=[n];return Gt(n)?t:t.concat(j(Ct(n).map(Je)))}function Dt(n,t){var e,i,r,s,o,a,h,u,c=new Set(n),d=ue(c),l=new Set(t);try{for(var v=E(l),y=v.next();!y.done;y=v.next())for(var p=y.value,S=p.parent;S&&!l.has(S);)l.add(S),S=S.parent}catch(O){e={error:O}}finally{try{y&&!y.done&&(i=v.return)&&i.call(v)}finally{if(e)throw e.error}}var m=ue(l);try{for(var g=E(l),w=g.next();!w.done;w=g.next()){var p=w.value;if(p.type==="compound"&&(!m.get(p)||!m.get(p).length))d.get(p)?d.get(p).forEach(function(k){return l.add(k)}):p.initialStateNodes.forEach(function(k){return l.add(k)});else if(p.type==="parallel")try{for(var b=(o=void 0,E(Ct(p))),I=b.next();!I.done;I=b.next()){var _=I.value;l.has(_)||(l.add(_),d.get(_)?d.get(_).forEach(function(k){return l.add(k)}):_.initialStateNodes.forEach(function(k){return l.add(k)}))}}catch(k){o={error:k}}finally{try{I&&!I.done&&(a=b.return)&&a.call(b)}finally{if(o)throw o.error}}}}catch(O){r={error:O}}finally{try{w&&!w.done&&(s=g.return)&&s.call(g)}finally{if(r)throw r.error}}try{for(var D=E(l),N=D.next();!N.done;N=D.next())for(var p=N.value,S=p.parent;S&&!l.has(S);)l.add(S),S=S.parent}catch(O){h={error:O}}finally{try{N&&!N.done&&(u=D.return)&&u.call(D)}finally{if(h)throw h.error}}return l}function Ke(n,t){var e=t.get(n);if(!e)return{};if(n.type==="compound"){var i=e[0];if(i){if(Gt(i))return i.key}else return{}}var r={};return e.forEach(function(s){r[s.key]=Ke(s,t)}),r}function ue(n){var t,e,i=new Map;try{for(var r=E(n),s=r.next();!s.done;s=r.next()){var o=s.value;i.has(o)||i.set(o,[]),o.parent&&(i.has(o.parent)||i.set(o.parent,[]),i.get(o.parent).push(o))}}catch(a){t={error:a}}finally{try{s&&!s.done&&(e=r.return)&&e.call(r)}finally{if(t)throw t.error}}return i}function Gn(n,t){var e=Dt([n],t);return Ke(n,ue(e))}function Tt(n,t){return Array.isArray(n)?n.some(function(e){return e===t}):n instanceof Set?n.has(t):!1}function Jn(n){return P([],M(new Set(j(P([],M(n.map(function(t){return t.ownEvents})),!1)))),!1)}function Jt(n,t){return t.type==="compound"?Ct(t).some(function(e){return e.type==="final"&&Tt(n,e)}):t.type==="parallel"?Ct(t).every(function(e){return Jt(n,e)}):!1}function Kn(n){return n===void 0&&(n=[]),n.reduce(function(t,e){return e.meta!==void 0&&(t[e.id]=e.meta),t},{})}function Ze(n){return new Set(j(n.map(function(t){return t.tags})))}function qe(n,t){if(n===t)return!0;if(n===void 0||t===void 0)return!1;if(C(n)||C(t))return n===t;var e=Object.keys(n),i=Object.keys(t);return e.length===i.length&&e.every(function(r){return qe(n[r],t[r])})}function Zn(n){return typeof n!="object"||n===null?!1:"value"in n&&"_event"in n}function qn(n,t){var e=n.exec,i=f(f({},n),{exec:e!==void 0?function(){return e(t.context,t.event,{action:n,state:t,_event:t._event})}:void 0});return i}var q=function(){function n(t){var e=this,i;this.actions=[],this.activities=Me,this.meta={},this.events=[],this.value=t.value,this.context=t.context,this._event=t._event,this._sessionid=t._sessionid,this.event=this._event.data,this.historyValue=t.historyValue,this.history=t.history,this.actions=t.actions||[],this.activities=t.activities||Me,this.meta=Kn(t.configuration),this.events=t.events||[],this.matches=this.matches.bind(this),this.toStrings=this.toStrings.bind(this),this.configuration=t.configuration,this.transitions=t.transitions,this.children=t.children,this.done=!!t.done,this.tags=(i=Array.isArray(t.tags)?new Set(t.tags):t.tags)!==null&&i!==void 0?i:new Set,this.machine=t.machine,Object.defineProperty(this,"nextEvents",{get:function(){return Jn(e.configuration)}})}return n.from=function(t,e){if(t instanceof n)return t.context!==e?new n({value:t.value,context:e,_event:t._event,_sessionid:null,historyValue:t.historyValue,history:t.history,actions:[],activities:t.activities,meta:{},events:[],configuration:[],transitions:[],children:{}}):t;var i=st;return new n({value:t,context:e,_event:i,_sessionid:null,historyValue:void 0,history:void 0,actions:[],activities:void 0,meta:void 0,events:[],configuration:[],transitions:[],children:{}})},n.create=function(t){return new n(t)},n.inert=function(t,e){if(t instanceof n){if(!t.actions.length)return t;var i=st;return new n({value:t.value,context:e,_event:i,_sessionid:null,historyValue:t.historyValue,history:t.history,activities:t.activities,configuration:t.configuration,transitions:[],children:{}})}return n.from(t,e)},n.prototype.toStrings=function(t,e){var i=this;if(t===void 0&&(t=this.value),e===void 0&&(e="."),C(t))return[t];var r=Object.keys(t);return r.concat.apply(r,P([],M(r.map(function(s){return i.toStrings(t[s],e).map(function(o){return s+e+o})})),!1))},n.prototype.toJSON=function(){var t=this;t.configuration,t.transitions;var e=t.tags;t.machine;var i=te(t,["configuration","transitions","tags","machine"]);return f(f({},i),{tags:Array.from(e)})},n.prototype.matches=function(t){return se(t,this.value)},n.prototype.hasTag=function(t){return this.tags.has(t)},n.prototype.can=function(t){var e;R&&H(!!this.machine,"state.can(...) used outside of a machine-created State object; this will always return false.");var i=(e=this.machine)===null||e===void 0?void 0:e.getTransitionData(this,t);return!!(i!=null&&i.transitions.length)&&i.transitions.some(function(r){return r.target!==void 0||r.actions.length})},n}(),Qn={deferEvents:!1},Qe=function(){function n(t){this.processingEvent=!1,this.queue=[],this.initialized=!1,this.options=f(f({},Qn),t)}return n.prototype.initialize=function(t){if(this.initialized=!0,t){if(!this.options.deferEvents){this.schedule(t);return}this.process(t)}this.flushEvents()},n.prototype.schedule=function(t){if(!this.initialized||this.processingEvent){this.queue.push(t);return}if(this.queue.length!==0)throw new Error("Event queue should be empty when it is not processing events");this.process(t),this.flushEvents()},n.prototype.clear=function(){this.queue=[]},n.prototype.flushEvents=function(){for(var t=this.queue.shift();t;)this.process(t),t=this.queue.shift()},n.prototype.process=function(t){this.processingEvent=!0;try{t()}catch(e){throw this.clear(),e}finally{this.processingEvent=!1}},n}(),ce=new Map,ti=0,_t={bookId:function(){return"x:".concat(ti++)},register:function(n,t){return ce.set(n,t),n},get:function(n){return ce.get(n)},free:function(n){ce.delete(n)}};function le(){if(typeof globalThis<"u")return globalThis;if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;R||console.warn("XState could not find a global object in this environment. Please let the maintainers know and raise an issue here: https://github.com/statelyai/xstate/issues")}function ei(){var n=le();if(n&&"__xstate__"in n)return n.__xstate__}function ni(n){if(le()){var t=ei();t&&t.register(n)}}function ii(n,t){t===void 0&&(t={});var e=n.initialState,i=new Set,r=[],s=!1,o=function(){if(!s){for(s=!0;r.length>0;){var u=r.shift();e=n.transition(e,u,h),i.forEach(function(c){return c.next(e)})}s=!1}},a=Bn({id:t.id,send:function(u){r.push(u),o()},getSnapshot:function(){return e},subscribe:function(u,c,d){var l=Xt(u,c,d);return i.add(l),l.next(e),{unsubscribe:function(){i.delete(l)}}}}),h={parent:t.parent,self:a,id:t.id||"anonymous",observers:i};return e=n.start?n.start(h):e,a}var ri={sync:!1,autoForward:!1},z;(function(n){n[n.NotStarted=0]="NotStarted",n[n.Running=1]="Running",n[n.Stopped=2]="Stopped"})(z||(z={}));var si=function(){function n(t,e){e===void 0&&(e=n.defaultOptions);var i=this;this.machine=t,this.delayedEventsMap={},this.listeners=new Set,this.contextListeners=new Set,this.stopListeners=new Set,this.doneListeners=new Set,this.eventListeners=new Set,this.sendListeners=new Set,this.initialized=!1,this.status=z.NotStarted,this.children=new Map,this.forwardTo=new Set,this._outgoingQueue=[],this.init=this.start,this.send=function(c,d){if(ct(c))return i.batch(c),i.state;var l=Y(Wt(c,d));if(i.status===z.Stopped)return R||H(!1,'Event "'.concat(l.name,'" was sent to stopped service "').concat(i.machine.id,`". This service has already reached its final state, and will not transition.
Event: `).concat(JSON.stringify(l.data))),i.state;if(i.status!==z.Running&&!i.options.deferEvents)throw new Error('Event "'.concat(l.name,'" was sent to uninitialized service "').concat(i.machine.id,`". Make sure .start() is called for this service, or set { deferEvents: true } in the service options.
Event: `).concat(JSON.stringify(l.data)));return i.scheduler.schedule(function(){i.forward(l);var v=i._nextState(l);i.update(v,l)}),i._state},this.sendTo=function(c,d,l){var v=i.parent&&(d===tt.Parent||i.parent.id===d),y=v?i.parent:C(d)?d===tt.Internal?i:i.children.get(d)||_t.get(d):Tn(d)?d:void 0;if(!y){if(!v)throw new Error("Unable to send event to child '".concat(d,"' from service '").concat(i.id,"'."));R||H(!1,"Service '".concat(i.id,"' has no parent: unable to send event ").concat(c.type));return}if("machine"in y){if(i.status!==z.Stopped||i.parent!==y||i.state.done){var p=f(f({},c),{name:c.name===ie?"".concat(ft(i.id)):c.name,origin:i.sessionId});!l&&i.machine.config.predictableActionArguments?i._outgoingQueue.push([y,p]):y.send(p)}}else!l&&i.machine.config.predictableActionArguments?i._outgoingQueue.push([y,c.data]):y.send(c.data)},this._exec=function(c,d,l,v){v===void 0&&(v=i.machine.options.actions);var y=c.exec||Vt(c.type,v),p=A(y)?y:y?y.exec:c.exec;if(p)try{return p(d,l.data,i.machine.config.predictableActionArguments?{action:c,_event:l}:{action:c,state:i.state,_event:l})}catch(U){throw i.parent&&i.parent.send({type:"xstate.error",data:U}),U}switch(c.type){case ut:{var S=c;i.defer(S);break}case bt:var m=c;if(typeof m.delay=="number"){i.defer(m);return}else m.to?i.sendTo(m._event,m.to,l===st):i.send(m._event);break;case ee:i.cancel(c.sendId);break;case It:{if(i.status!==z.Running)return;var g=c.activity;if(!i.machine.config.predictableActionArguments&&!i.state.activities[g.id||g.type])break;if(g.type===T.Invoke){var w=Le(g.src),b=i.machine.options.services?i.machine.options.services[w.type]:void 0,I=g.id,_=g.data;R||H(!("forward"in g),"`forward` property is deprecated (found in invocation of '".concat(g.src,"' in in machine '").concat(i.machine.id,"'). ")+"Please use `autoForward` instead.");var D="autoForward"in g?g.autoForward:!!g.forward;if(!b){R||H(!1,"No service found for invocation '".concat(g.src,"' in machine '").concat(i.machine.id,"'."));return}var N=_?Ut(_,d,l):void 0;if(typeof b=="string")return;var O=A(b)?b(d,l.data,{data:N,src:w,meta:g.meta}):b;if(!O)return;var k=void 0;rt(O)&&(O=N?O.withContext(N):O,k={autoForward:D}),i.spawn(O,I,k)}else i.spawnActivity(g);break}case Lt:{i.stopChild(c.activity.id);break}case Rt:var x=c,L=x.label,F=x.value;L?i.logger(L,F):i.logger(F);break;default:R||H(!1,"No implementation found for action type '".concat(c.type,"'"));break}};var r=f(f({},n.defaultOptions),e),s=r.clock,o=r.logger,a=r.parent,h=r.id,u=h!==void 0?h:t.id;this.id=u,this.logger=o,this.clock=s,this.parent=a,this.options=r,this.scheduler=new Qe({deferEvents:this.options.deferEvents}),this.sessionId=_t.bookId()}return Object.defineProperty(n.prototype,"initialState",{get:function(){var t=this;return this._initialState?this._initialState:vt(this,function(){return t._initialState=t.machine.initialState,t._initialState})},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"state",{get:function(){return R||H(this.status!==z.NotStarted,"Attempted to read state from uninitialized service '".concat(this.id,"'. Make sure the service is started first.")),this._state},enumerable:!1,configurable:!0}),n.prototype.execute=function(t,e){var i,r;try{for(var s=E(t.actions),o=s.next();!o.done;o=s.next()){var a=o.value;this.exec(a,t,e)}}catch(h){i={error:h}}finally{try{o&&!o.done&&(r=s.return)&&r.call(s)}finally{if(i)throw i.error}}},n.prototype.update=function(t,e){var i,r,s,o,a,h,u,c,d=this;if(t._sessionid=this.sessionId,this._state=t,(!this.machine.config.predictableActionArguments||e===st)&&this.options.execute)this.execute(this.state);else for(var l=void 0;l=this._outgoingQueue.shift();)l[0].send(l[1]);if(this.children.forEach(function(O){d.state.children[O.id]=O}),this.devTools&&this.devTools.send(e.data,t),t.event)try{for(var v=E(this.eventListeners),y=v.next();!y.done;y=v.next()){var p=y.value;p(t.event)}}catch(O){i={error:O}}finally{try{y&&!y.done&&(r=v.return)&&r.call(v)}finally{if(i)throw i.error}}try{for(var S=E(this.listeners),m=S.next();!m.done;m=S.next()){var p=m.value;p(t,t.event)}}catch(O){s={error:O}}finally{try{m&&!m.done&&(o=S.return)&&o.call(S)}finally{if(s)throw s.error}}try{for(var g=E(this.contextListeners),w=g.next();!w.done;w=g.next()){var b=w.value;b(this.state.context,this.state.history?this.state.history.context:void 0)}}catch(O){a={error:O}}finally{try{w&&!w.done&&(h=g.return)&&h.call(g)}finally{if(a)throw a.error}}if(this.state.done){var I=t.configuration.find(function(O){return O.type==="final"&&O.parent===d.machine}),_=I&&I.doneData?Ut(I.doneData,t.context,e):void 0;this._doneEvent=Mt(this.id,_);try{for(var D=E(this.doneListeners),N=D.next();!N.done;N=D.next()){var p=N.value;p(this._doneEvent)}}catch(O){u={error:O}}finally{try{N&&!N.done&&(c=D.return)&&c.call(D)}finally{if(u)throw u.error}}this._stop(),this._stopChildren(),_t.free(this.sessionId)}},n.prototype.onTransition=function(t){return this.listeners.add(t),this.status===z.Running&&t(this.state,this.state.event),this},n.prototype.subscribe=function(t,e,i){var r=this,s=Xt(t,e,i);this.listeners.add(s.next),this.status!==z.NotStarted&&s.next(this.state);var o=function(){r.doneListeners.delete(o),r.stopListeners.delete(o),s.complete()};return this.status===z.Stopped?s.complete():(this.onDone(o),this.onStop(o)),{unsubscribe:function(){r.listeners.delete(s.next),r.doneListeners.delete(o),r.stopListeners.delete(o)}}},n.prototype.onEvent=function(t){return this.eventListeners.add(t),this},n.prototype.onSend=function(t){return this.sendListeners.add(t),this},n.prototype.onChange=function(t){return this.contextListeners.add(t),this},n.prototype.onStop=function(t){return this.stopListeners.add(t),this},n.prototype.onDone=function(t){return this.status===z.Stopped&&this._doneEvent?t(this._doneEvent):this.doneListeners.add(t),this},n.prototype.off=function(t){return this.listeners.delete(t),this.eventListeners.delete(t),this.sendListeners.delete(t),this.stopListeners.delete(t),this.doneListeners.delete(t),this.contextListeners.delete(t),this},n.prototype.start=function(t){var e=this;if(this.status===z.Running)return this;this.machine._init(),_t.register(this.sessionId,this),this.initialized=!0,this.status=z.Running;var i=t===void 0?this.initialState:vt(this,function(){return Zn(t)?e.machine.resolveState(t):e.machine.resolveState(q.from(t,e.machine.context))});return this.options.devTools&&this.attachDev(),this.scheduler.initialize(function(){e.update(i,st)}),this},n.prototype._stopChildren=function(){this.children.forEach(function(t){A(t.stop)&&t.stop()}),this.children.clear()},n.prototype._stop=function(){var t,e,i,r,s,o,a,h,u,c;try{for(var d=E(this.listeners),l=d.next();!l.done;l=d.next()){var v=l.value;this.listeners.delete(v)}}catch(D){t={error:D}}finally{try{l&&!l.done&&(e=d.return)&&e.call(d)}finally{if(t)throw t.error}}try{for(var y=E(this.stopListeners),p=y.next();!p.done;p=y.next()){var v=p.value;v(),this.stopListeners.delete(v)}}catch(D){i={error:D}}finally{try{p&&!p.done&&(r=y.return)&&r.call(y)}finally{if(i)throw i.error}}try{for(var S=E(this.contextListeners),m=S.next();!m.done;m=S.next()){var v=m.value;this.contextListeners.delete(v)}}catch(D){s={error:D}}finally{try{m&&!m.done&&(o=S.return)&&o.call(S)}finally{if(s)throw s.error}}try{for(var g=E(this.doneListeners),w=g.next();!w.done;w=g.next()){var v=w.value;this.doneListeners.delete(v)}}catch(D){a={error:D}}finally{try{w&&!w.done&&(h=g.return)&&h.call(g)}finally{if(a)throw a.error}}if(!this.initialized)return this;this.initialized=!1,this.status=z.Stopped,this._initialState=void 0;try{for(var b=E(Object.keys(this.delayedEventsMap)),I=b.next();!I.done;I=b.next()){var _=I.value;this.clock.clearTimeout(this.delayedEventsMap[_])}}catch(D){u={error:D}}finally{try{I&&!I.done&&(c=b.return)&&c.call(b)}finally{if(u)throw u.error}}this.scheduler.clear(),this.scheduler=new Qe({deferEvents:this.options.deferEvents})},n.prototype.stop=function(){var t=this,e=this.scheduler;return this._stop(),e.schedule(function(){var i;if(!(!((i=t._state)===null||i===void 0)&&i.done)){var r=Y({type:"xstate.stop"}),s=vt(t,function(){var o=j(P([],M(t.state.configuration),!1).sort(function(d,l){return l.order-d.order}).map(function(d){return Q(d.onExit,t.machine.options.actions)})),a=M(At(t.machine,t.state,t.state.context,r,[{type:"exit",actions:o}],t.machine.config.predictableActionArguments?t._exec:void 0,t.machine.config.predictableActionArguments||t.machine.config.preserveActionOrder),2),h=a[0],u=a[1],c=new q({value:t.state.value,context:u,_event:r,_sessionid:t.sessionId,historyValue:void 0,history:t.state,actions:h.filter(function(d){return!ae(d)}),activities:{},events:[],configuration:[],transitions:[],children:{},done:t.state.done,tags:t.state.tags,machine:t.machine});return c.changed=!0,c});t.update(s,r),t._stopChildren(),_t.free(t.sessionId)}}),this},n.prototype.batch=function(t){var e=this;if(this.status===z.NotStarted&&this.options.deferEvents)R||H(!1,"".concat(t.length,' event(s) were sent to uninitialized service "').concat(this.machine.id,`" and are deferred. Make sure .start() is called for this service.
Event: `).concat(JSON.stringify(event)));else if(this.status!==z.Running)throw new Error("".concat(t.length,' event(s) were sent to uninitialized service "').concat(this.machine.id,'". Make sure .start() is called for this service, or set { deferEvents: true } in the service options.'));if(t.length){var i=!!this.machine.config.predictableActionArguments&&this._exec;this.scheduler.schedule(function(){var r,s,o=e.state,a=!1,h=[],u=function(v){var y=Y(v);e.forward(y),o=vt(e,function(){return e.machine.transition(o,y,void 0,i||void 0)}),h.push.apply(h,P([],M(e.machine.config.predictableActionArguments?o.actions:o.actions.map(function(p){return qn(p,o)})),!1)),a=a||!!o.changed};try{for(var c=E(t),d=c.next();!d.done;d=c.next()){var l=d.value;u(l)}}catch(v){r={error:v}}finally{try{d&&!d.done&&(s=c.return)&&s.call(c)}finally{if(r)throw r.error}}o.changed=a,o.actions=h,e.update(o,Y(t[t.length-1]))})}},n.prototype.sender=function(t){return this.send.bind(this,t)},n.prototype._nextState=function(t,e){var i=this;e===void 0&&(e=!!this.machine.config.predictableActionArguments&&this._exec);var r=Y(t);if(r.name.indexOf(ne)===0&&!this.state.nextEvents.some(function(o){return o.indexOf(ne)===0}))throw r.data.data;var s=vt(this,function(){return i.machine.transition(i.state,r,void 0,e||void 0)});return s},n.prototype.nextState=function(t){return this._nextState(t,!1)},n.prototype.forward=function(t){var e,i;try{for(var r=E(this.forwardTo),s=r.next();!s.done;s=r.next()){var o=s.value,a=this.children.get(o);if(!a)throw new Error("Unable to forward event '".concat(t,"' from interpreter '").concat(this.id,"' to nonexistant child '").concat(o,"'."));a.send(t)}}catch(h){e={error:h}}finally{try{s&&!s.done&&(i=r.return)&&i.call(r)}finally{if(e)throw e.error}}},n.prototype.defer=function(t){var e=this,i=this.clock.setTimeout(function(){"to"in t&&t.to?e.sendTo(t._event,t.to,!0):e.send(t._event)},t.delay);t.id&&(this.delayedEventsMap[t.id]=i)},n.prototype.cancel=function(t){this.clock.clearTimeout(this.delayedEventsMap[t]),delete this.delayedEventsMap[t]},n.prototype.exec=function(t,e,i){i===void 0&&(i=this.machine.options.actions),this._exec(t,e.context,e._event,i)},n.prototype.removeChild=function(t){var e;this.children.delete(t),this.forwardTo.delete(t),(e=this.state)===null||e===void 0||delete e.children[t]},n.prototype.stopChild=function(t){var e=this.children.get(t);e&&(this.removeChild(t),A(e.stop)&&e.stop())},n.prototype.spawn=function(t,e,i){if(this.status!==z.Running)return Be(t,e);if(Te(t))return this.spawnPromise(Promise.resolve(t),e);if(A(t))return this.spawnCallback(t,e);if(Vn(t))return this.spawnActor(t,e);if(Dn(t))return this.spawnObservable(t,e);if(rt(t))return this.spawnMachine(t,f(f({},i),{id:e}));if(Mn(t))return this.spawnBehavior(t,e);throw new Error('Unable to spawn entity "'.concat(e,'" of type "').concat(typeof t,'".'))},n.prototype.spawnMachine=function(t,e){var i=this;e===void 0&&(e={});var r=new n(t,f(f({},this.options),{parent:this,id:e.id||t.id})),s=f(f({},ri),e);s.sync&&r.onTransition(function(a){i.send(zt,{state:a,id:r.id})});var o=r;return this.children.set(r.id,o),s.autoForward&&this.forwardTo.add(r.id),r.onDone(function(a){i.removeChild(r.id),i.send(Y(a,{origin:r.id}))}).start(),o},n.prototype.spawnBehavior=function(t,e){var i=ii(t,{id:e,parent:this});return this.children.set(e,i),i},n.prototype.spawnPromise=function(t,e){var i,r=this,s=!1,o;t.then(function(h){s||(o=h,r.removeChild(e),r.send(Y(Mt(e,h),{origin:e})))},function(h){if(!s){r.removeChild(e);var u=ft(e,h);try{r.send(Y(u,{origin:e}))}catch(c){Nn(h,c,e),r.devTools&&r.devTools.send(u,r.state),r.machine.strict&&r.stop()}}});var a=(i={id:e,send:function(){},subscribe:function(h,u,c){var d=Xt(h,u,c),l=!1;return t.then(function(v){l||(d.next(v),!l&&d.complete())},function(v){l||d.error(v)}),{unsubscribe:function(){return l=!0}}},stop:function(){s=!0},toJSON:function(){return{id:e}},getSnapshot:function(){return o}},i[et]=function(){return this},i);return this.children.set(e,a),a},n.prototype.spawnCallback=function(t,e){var i,r=this,s=!1,o=new Set,a=new Set,h,u=function(l){h=l,a.forEach(function(v){return v(l)}),!s&&r.send(Y(l,{origin:e}))},c;try{c=t(u,function(l){o.add(l)})}catch(l){this.send(ft(e,l))}if(Te(c))return this.spawnPromise(c,e);var d=(i={id:e,send:function(l){return o.forEach(function(v){return v(l)})},subscribe:function(l){var v=Xt(l);return a.add(v.next),{unsubscribe:function(){a.delete(v.next)}}},stop:function(){s=!0,A(c)&&c()},toJSON:function(){return{id:e}},getSnapshot:function(){return h}},i[et]=function(){return this},i);return this.children.set(e,d),d},n.prototype.spawnObservable=function(t,e){var i,r=this,s,o=t.subscribe(function(h){s=h,r.send(Y(h,{origin:e}))},function(h){r.removeChild(e),r.send(Y(ft(e,h),{origin:e}))},function(){r.removeChild(e),r.send(Y(Mt(e),{origin:e}))}),a=(i={id:e,send:function(){},subscribe:function(h,u,c){return t.subscribe(h,u,c)},stop:function(){return o.unsubscribe()},getSnapshot:function(){return s},toJSON:function(){return{id:e}}},i[et]=function(){return this},i);return this.children.set(e,a),a},n.prototype.spawnActor=function(t,e){return this.children.set(e,t),t},n.prototype.spawnActivity=function(t){var e=this.machine.options&&this.machine.options.activities?this.machine.options.activities[t.type]:void 0;if(!e){R||H(!1,"No implementation found for activity '".concat(t.type,"'"));return}var i=e(this.state.context,t);this.spawnEffect(t.id,i)},n.prototype.spawnEffect=function(t,e){var i;this.children.set(t,(i={id:t,send:function(){},subscribe:function(){return{unsubscribe:function(){}}},stop:e||void 0,getSnapshot:function(){},toJSON:function(){return{id:t}}},i[et]=function(){return this},i))},n.prototype.attachDev=function(){var t=le();if(this.options.devTools&&t){if(t.__REDUX_DEVTOOLS_EXTENSION__){var e=typeof this.options.devTools=="object"?this.options.devTools:void 0;this.devTools=t.__REDUX_DEVTOOLS_EXTENSION__.connect(f(f({name:this.id,autoPause:!0,stateSanitizer:function(i){return{value:i.value,context:i.context,actions:i.actions}}},e),{features:f({jump:!1,skip:!1},e?e.features:void 0)}),this.machine),this.devTools.init(this.state)}ni(this)}},n.prototype.toJSON=function(){return{id:this.id}},n.prototype[et]=function(){return this},n.prototype.getSnapshot=function(){return this.status===z.NotStarted?this.initialState:this._state},n.defaultOptions={execute:!0,deferEvents:!0,clock:{setTimeout:function(t,e){return setTimeout(t,e)},clearTimeout:function(t){return clearTimeout(t)}},logger:console.log.bind(console),devTools:!1},n.interpret=tn,n}();function tn(n,t){var e=new si(n,t);return e}function oi(n){if(typeof n=="string"){var t={type:n};return t.toString=function(){return n},t}return n}function Kt(n){return f(f({type:kt},n),{toJSON:function(){n.onDone,n.onError;var t=te(n,["onDone","onError"]);return f(f({},t),{type:kt,src:oi(n.src)})}})}var pt="",de="#",Nt="*",yt={},gt=function(n){return n[0]===de},ai=function(){return{actions:{},guards:{},services:{},activities:{},delays:{}}},hi=function(n,t,e){var i=e.slice(0,-1).some(function(s){return!("cond"in s)&&!("in"in s)&&(C(s.target)||rt(s.target))}),r=t===pt?"the transient event":"event '".concat(t,"'");H(!i,"One or more transitions for ".concat(r," on state '").concat(n.id,"' are unreachable. ")+"Make sure that the default transition is the last one defined.")},ui=function(){function n(t,e,i,r){i===void 0&&(i="context"in t?t.context:void 0);var s=this,o;this.config=t,this._context=i,this.order=-1,this.__xstatenode=!0,this.__cache={events:void 0,relativeValue:new Map,initialStateValue:void 0,initialState:void 0,on:void 0,transitions:void 0,candidates:{},delayedTransitions:void 0},this.idMap={},this.tags=[],this.options=Object.assign(ai(),e),this.parent=r==null?void 0:r.parent,this.key=this.config.key||(r==null?void 0:r.key)||this.config.id||"(machine)",this.machine=this.parent?this.parent.machine:this,this.path=this.parent?this.parent.path.concat(this.key):[],this.delimiter=this.config.delimiter||(this.parent?this.parent.delimiter:Oe),this.id=this.config.id||P([this.machine.key],M(this.path),!1).join(this.delimiter),this.version=this.parent?this.parent.version:this.config.version,this.type=this.config.type||(this.config.parallel?"parallel":this.config.states&&Object.keys(this.config.states).length?"compound":this.config.history?"history":"atomic"),this.schema=this.parent?this.machine.schema:(o=this.config.schema)!==null&&o!==void 0?o:{},this.description=this.config.description,R||H(!("parallel"in this.config),'The "parallel" property is deprecated and will be removed in version 4.1. '.concat(this.config.parallel?"Replace with `type: 'parallel'`":"Use `type: '".concat(this.type,"'`")," in the config for state node '").concat(this.id,"' instead.")),this.initial=this.config.initial,this.states=this.config.states?Et(this.config.states,function(u,c){var d,l=new n(u,{},void 0,{parent:s,key:c});return Object.assign(s.idMap,f((d={},d[l.id]=l,d),l.idMap)),l}):yt;var a=0;function h(u){var c,d;u.order=a++;try{for(var l=E(Ge(u)),v=l.next();!v.done;v=l.next()){var y=v.value;h(y)}}catch(p){c={error:p}}finally{try{v&&!v.done&&(d=l.return)&&d.call(l)}finally{if(c)throw c.error}}}h(this),this.history=this.config.history===!0?"shallow":this.config.history||!1,this._transient=!!this.config.always||(this.config.on?Array.isArray(this.config.on)?this.config.on.some(function(u){var c=u.event;return c===pt}):pt in this.config.on:!1),this.strict=!!this.config.strict,this.onEntry=V(this.config.entry||this.config.onEntry).map(function(u){return dt(u)}),this.onExit=V(this.config.exit||this.config.onExit).map(function(u){return dt(u)}),this.meta=this.config.meta,this.doneData=this.type==="final"?this.config.data:void 0,this.invoke=V(this.config.invoke).map(function(u,c){var d,l;if(rt(u)){var v=$t(s.id,c);return s.machine.options.services=f((d={},d[v]=u,d),s.machine.options.services),Kt({src:v,id:v})}else if(C(u.src)){var v=u.id||$t(s.id,c);return Kt(f(f({},u),{id:v,src:u.src}))}else if(rt(u.src)||A(u.src)){var v=u.id||$t(s.id,c);return s.machine.options.services=f((l={},l[v]=u.src,l),s.machine.options.services),Kt(f(f({id:v},u),{src:v}))}else{var y=u.src;return Kt(f(f({id:$t(s.id,c)},u),{src:y}))}}),this.activities=V(this.config.activities).concat(this.invoke).map(function(u){return Bt(u)}),this.transition=this.transition.bind(this),this.tags=V(this.config.tags)}return n.prototype._init=function(){this.__cache.transitions||Je(this).forEach(function(t){return t.on})},n.prototype.withConfig=function(t,e){var i=this.options,r=i.actions,s=i.activities,o=i.guards,a=i.services,h=i.delays;return new n(this.config,{actions:f(f({},r),t.actions),activities:f(f({},s),t.activities),guards:f(f({},o),t.guards),services:f(f({},a),t.services),delays:f(f({},h),t.delays)},e??this.context)},n.prototype.withContext=function(t){return new n(this.config,this.options,t)},Object.defineProperty(n.prototype,"context",{get:function(){return A(this._context)?this._context():this._context},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"definition",{get:function(){return{id:this.id,key:this.key,version:this.version,context:this.context,type:this.type,initial:this.initial,history:this.history,states:Et(this.states,function(t){return t.definition}),on:this.on,transitions:this.transitions,entry:this.onEntry,exit:this.onExit,activities:this.activities||[],meta:this.meta,order:this.order||-1,data:this.doneData,invoke:this.invoke,description:this.description,tags:this.tags}},enumerable:!1,configurable:!0}),n.prototype.toJSON=function(){return this.definition},Object.defineProperty(n.prototype,"on",{get:function(){if(this.__cache.on)return this.__cache.on;var t=this.transitions;return this.__cache.on=t.reduce(function(e,i){return e[i.eventType]=e[i.eventType]||[],e[i.eventType].push(i),e},{})},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"after",{get:function(){return this.__cache.delayedTransitions||(this.__cache.delayedTransitions=this.getDelayedTransitions(),this.__cache.delayedTransitions)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"transitions",{get:function(){return this.__cache.transitions||(this.__cache.transitions=this.formatTransitions(),this.__cache.transitions)},enumerable:!1,configurable:!0}),n.prototype.getCandidates=function(t){if(this.__cache.candidates[t])return this.__cache.candidates[t];var e=t===pt,i=this.transitions.filter(function(r){var s=r.eventType===t;return e?s:s||r.eventType===Nt});return this.__cache.candidates[t]=i,i},n.prototype.getDelayedTransitions=function(){var t=this,e=this.config.after;if(!e)return[];var i=function(s,o){var a=A(s)?"".concat(t.id,":delay[").concat(o,"]"):s,h=Xe(a,t.id);return t.onEntry.push(ot(h,{delay:s})),t.onExit.push(Fe(h)),h},r=ct(e)?e.map(function(s,o){var a=i(s.delay,o);return f(f({},s),{event:a})}):j(Object.keys(e).map(function(s,o){var a=e[s],h=C(a)?{target:a}:a,u=isNaN(+s)?s:+s,c=i(u,o);return V(h).map(function(d){return f(f({},d),{event:c,delay:u})})}));return r.map(function(s){var o=s.delay;return f(f({},t.formatTransition(s)),{delay:o})})},n.prototype.getStateNodes=function(t){var e,i=this;if(!t)return[];var r=t instanceof q?t.value:xt(t,this.delimiter);if(C(r)){var s=this.getStateNode(r).initial;return s!==void 0?this.getStateNodes((e={},e[r]=s,e)):[this,this.states[r]]}var o=Object.keys(r),a=[this];return a.push.apply(a,P([],M(j(o.map(function(h){return i.getStateNode(h).getStateNodes(r[h])}))),!1)),a},n.prototype.handles=function(t){var e=Ae(t);return this.events.includes(e)},n.prototype.resolveState=function(t){var e=t instanceof q?t:q.create(t),i=Array.from(Dt([],this.getStateNodes(e.value)));return new q(f(f({},e),{value:this.resolve(e.value),configuration:i,done:Jt(i,this),tags:Ze(i),machine:this.machine}))},n.prototype.transitionLeafNode=function(t,e,i){var r=this.getStateNode(t),s=r.next(e,i);return!s||!s.transitions.length?this.next(e,i):s},n.prototype.transitionCompoundNode=function(t,e,i){var r=Object.keys(t),s=this.getStateNode(r[0]),o=s._transition(t[r[0]],e,i);return!o||!o.transitions.length?this.next(e,i):o},n.prototype.transitionParallelNode=function(t,e,i){var r,s,o={};try{for(var a=E(Object.keys(t)),h=a.next();!h.done;h=a.next()){var u=h.value,c=t[u];if(c){var d=this.getStateNode(u),l=d._transition(c,e,i);l&&(o[u]=l)}}}catch(m){r={error:m}}finally{try{h&&!h.done&&(s=a.return)&&s.call(a)}finally{if(r)throw r.error}}var v=Object.keys(o).map(function(m){return o[m]}),y=j(v.map(function(m){return m.transitions})),p=v.some(function(m){return m.transitions.length>0});if(!p)return this.next(e,i);var S=j(Object.keys(o).map(function(m){return o[m].configuration}));return{transitions:y,exitSet:j(v.map(function(m){return m.exitSet})),configuration:S,source:e,actions:j(Object.keys(o).map(function(m){return o[m].actions}))}},n.prototype._transition=function(t,e,i){return C(t)?this.transitionLeafNode(t,e,i):Object.keys(t).length===1?this.transitionCompoundNode(t,e,i):this.transitionParallelNode(t,e,i)},n.prototype.getTransitionData=function(t,e){return this._transition(t.value,t,Y(e))},n.prototype.next=function(t,e){var i,r,s=this,o=e.name,a=[],h=[],u;try{for(var c=E(this.getCandidates(o)),d=c.next();!d.done;d=c.next()){var l=d.value,v=l.cond,y=l.in,p=t.context,S=y?C(y)&&gt(y)?t.matches(xt(this.getStateNodeById(y).path,this.delimiter)):se(xt(y,this.delimiter),xn(this.path.slice(0,-2))(t.value)):!0,m=!1;try{m=!v||Ie(this.machine,v,p,e,t)}catch(b){throw new Error("Unable to evaluate guard '".concat(v.name||v.type,"' in transition for event '").concat(o,"' in state node '").concat(this.id,`':
`).concat(b.message))}if(m&&S){l.target!==void 0&&(h=l.target),a.push.apply(a,P([],M(l.actions),!1)),u=l;break}}}catch(b){i={error:b}}finally{try{d&&!d.done&&(r=c.return)&&r.call(c)}finally{if(i)throw i.error}}if(u){if(!h.length)return{transitions:[u],exitSet:[],configuration:t.value?[this]:[],source:t,actions:a};var g=j(h.map(function(b){return s.getRelativeStateNodes(b,t.historyValue)})),w=!!u.internal;return{transitions:[u],exitSet:w?[]:j(h.map(function(b){return s.getPotentiallyReenteringNodes(b)})),configuration:g,source:t,actions:a}}},n.prototype.getPotentiallyReenteringNodes=function(t){if(this.order<t.order)return[this];for(var e=[],i=this,r=t;i&&i!==r;)e.push(i),i=i.parent;return i!==r?[]:(e.push(r),e)},n.prototype.getActions=function(t,e,i,r,s,o,a){var h,u,c,d,l=this,v=o?Dt([],this.getStateNodes(o.value)):[],y=new Set;try{for(var p=E(Array.from(t).sort(function(x,L){return x.order-L.order})),S=p.next();!S.done;S=p.next()){var m=S.value;(!Tt(v,m)||Tt(i.exitSet,m)||m.parent&&y.has(m.parent))&&y.add(m)}}catch(x){h={error:x}}finally{try{S&&!S.done&&(u=p.return)&&u.call(p)}finally{if(h)throw h.error}}try{for(var g=E(v),w=g.next();!w.done;w=g.next()){var m=w.value;(!Tt(t,m)||Tt(i.exitSet,m.parent))&&i.exitSet.push(m)}}catch(x){c={error:x}}finally{try{w&&!w.done&&(d=g.return)&&d.call(g)}finally{if(c)throw c.error}}i.exitSet.sort(function(x,L){return L.order-x.order});var b=Array.from(y).sort(function(x,L){return x.order-L.order}),I=new Set(i.exitSet),_=j(b.map(function(x){var L=[];if(x.type!=="final")return L;var F=x.parent;if(!F.parent)return L;L.push(Ot(x.id,x.doneData),Ot(F.id,x.doneData?Ut(x.doneData,r,s):void 0));var U=F.parent;return U.type==="parallel"&&Ct(U).every(function(Pt){return Jt(i.configuration,Pt)})&&L.push(Ot(U.id)),L})),D=b.map(function(x){var L=x.onEntry,F=x.activities.map(function(U){return He(U)});return{type:"entry",actions:Q(a?P(P([],M(L),!1),M(F),!1):P(P([],M(F),!1),M(L),!1),l.machine.options.actions)}}).concat({type:"state_done",actions:_.map(function(x){return je(x)})}),N=Array.from(I).map(function(x){return{type:"exit",actions:Q(P(P([],M(x.onExit),!1),M(x.activities.map(function(L){return Ye(L)})),!1),l.machine.options.actions)}}),O=N.concat({type:"transition",actions:Q(i.actions,this.machine.options.actions)}).concat(D);if(e){var k=Q(j(P([],M(t),!1).sort(function(x,L){return L.order-x.order}).map(function(x){return x.onExit})),this.machine.options.actions).filter(function(x){return!ae(x)});return O.concat({type:"stop",actions:k})}return O},n.prototype.transition=function(t,e,i,r){t===void 0&&(t=this.initialState);var s=Y(e),o;if(t instanceof q)o=i===void 0?t:this.resolveState(q.from(t,i));else{var a=C(t)?this.resolve(Ht(this.getResolvedPath(t))):this.resolve(t),h=i??this.machine.context;o=this.resolveState(q.from(a,h))}if(!R&&s.name===Nt)throw new Error("An event cannot have the wildcard type ('".concat(Nt,"')"));if(this.strict&&!this.events.includes(s.name)&&!On(s.name))throw new Error("Machine '".concat(this.id,"' does not accept event '").concat(s.name,"'"));var u=this._transition(o.value,o,s)||{transitions:[],configuration:[],exitSet:[],source:o,actions:[]},c=Dt([],this.getStateNodes(o.value)),d=u.configuration.length?Dt(c,u.configuration):c;return u.configuration=P([],M(d),!1),this.resolveTransition(u,o,o.context,r,s)},n.prototype.resolveRaisedTransition=function(t,e,i,r){var s,o=t.actions;return t=this.transition(t,e,void 0,r),t._event=i,t.event=i.data,(s=t.actions).unshift.apply(s,P([],M(o),!1)),t},n.prototype.resolveTransition=function(t,e,i,r,s){var o,a,h,u,c=this;s===void 0&&(s=st);var d=t.configuration,l=!e||t.transitions.length>0,v=l?t.configuration:e?e.configuration:[],y=Jt(v,this),p=l?Gn(this.machine,d):void 0,S=e?e.historyValue?e.historyValue:t.source?this.machine.historyValue(e.value):void 0:void 0,m=this.getActions(new Set(v),y,t,i,s,e,r),g=e?f({},e.activities):{};try{for(var w=E(m),b=w.next();!b.done;b=w.next()){var I=b.value;try{for(var _=(h=void 0,E(I.actions)),D=_.next();!D.done;D=_.next()){var N=D.value;N.type===It?g[N.activity.id||N.activity.type]=N:N.type===Lt&&(g[N.activity.id||N.activity.type]=!1)}}catch(J){h={error:J}}finally{try{D&&!D.done&&(u=_.return)&&u.call(_)}finally{if(h)throw h.error}}}}catch(J){o={error:J}}finally{try{b&&!b.done&&(a=w.return)&&a.call(w)}finally{if(o)throw o.error}}var O=M(At(this,e,i,s,m,r,this.machine.config.predictableActionArguments||this.machine.config.preserveActionOrder),2),k=O[0],x=O[1],L=M(An(k,ae),2),F=L[0],U=L[1],Pt=k.filter(function(J){var St;return J.type===It&&((St=J.activity)===null||St===void 0?void 0:St.type)===kt}),ge=Pt.reduce(function(J,St){return J[St.activity.id]=Xn(St.activity,c.machine,x,s),J},e?f({},e.children):{}),at=new q({value:p||e.value,context:x,_event:s,_sessionid:e?e._sessionid:null,historyValue:p?S?Cn(S,p):void 0:e?e.historyValue:void 0,history:!p||t.source?e:void 0,actions:p?U:[],activities:p?g:e?e.activities:{},events:[],configuration:v,transitions:t.transitions,children:ge,done:y,tags:Ze(v),machine:this}),nt=i!==x;at.changed=s.name===zt||nt;var B=at.history;B&&delete B.history;var un=!y&&(this._transient||d.some(function(J){return J._transient}));if(!l&&(!un||s.name===pt))return at;var G=at;if(!y)for(un&&(G=this.resolveRaisedTransition(G,{type:Se},s,r));F.length;){var Ni=F.shift();G=this.resolveRaisedTransition(G,Ni._event,s,r)}var Pi=G.changed||(B?!!G.actions.length||nt||typeof B.value!=typeof G.value||!qe(G.value,B.value):void 0);return G.changed=Pi,G.history=B,G},n.prototype.getStateNode=function(t){if(gt(t))return this.machine.getStateNodeById(t);if(!this.states)throw new Error("Unable to retrieve child state '".concat(t,"' from '").concat(this.id,"'; no child states exist."));var e=this.states[t];if(!e)throw new Error("Child state '".concat(t,"' does not exist on '").concat(this.id,"'"));return e},n.prototype.getStateNodeById=function(t){var e=gt(t)?t.slice(de.length):t;if(e===this.id)return this;var i=this.machine.idMap[e];if(!i)throw new Error("Child state node '#".concat(e,"' does not exist on machine '").concat(this.id,"'"));return i},n.prototype.getStateNodeByPath=function(t){if(typeof t=="string"&&gt(t))try{return this.getStateNodeById(t.slice(1))}catch{}for(var e=oe(t,this.delimiter).slice(),i=this;e.length;){var r=e.shift();if(!r.length)break;i=i.getStateNode(r)}return i},n.prototype.resolve=function(t){var e,i=this;if(!t)return this.initialStateValue||yt;switch(this.type){case"parallel":return Et(this.initialStateValue,function(s,o){return s?i.getStateNode(o).resolve(t[o]||s):yt});case"compound":if(C(t)){var r=this.getStateNode(t);return r.type==="parallel"||r.type==="compound"?(e={},e[t]=r.initialStateValue,e):t}return Object.keys(t).length?Et(t,function(s,o){return s?i.getStateNode(o).resolve(s):yt}):this.initialStateValue||{};default:return t||yt}},n.prototype.getResolvedPath=function(t){if(gt(t)){var e=this.machine.idMap[t.slice(de.length)];if(!e)throw new Error("Unable to find state node '".concat(t,"'"));return e.path}return oe(t,this.delimiter)},Object.defineProperty(n.prototype,"initialStateValue",{get:function(){var t;if(this.__cache.initialStateValue)return this.__cache.initialStateValue;var e;if(this.type==="parallel")e=Ce(this.states,function(i){return i.initialStateValue||yt},function(i){return i.type!=="history"});else if(this.initial!==void 0){if(!this.states[this.initial])throw new Error("Initial state '".concat(this.initial,"' not found on '").concat(this.key,"'"));e=Gt(this.states[this.initial])?this.initial:(t={},t[this.initial]=this.states[this.initial].initialStateValue,t)}else e={};return this.__cache.initialStateValue=e,this.__cache.initialStateValue},enumerable:!1,configurable:!0}),n.prototype.getInitialState=function(t,e){this._init();var i=this.getStateNodes(t);return this.resolveTransition({configuration:i,exitSet:[],transitions:[],source:void 0,actions:[]},void 0,e??this.machine.context,void 0)},Object.defineProperty(n.prototype,"initialState",{get:function(){var t=this.initialStateValue;if(!t)throw new Error("Cannot retrieve initial state from simple state '".concat(this.id,"'."));return this.getInitialState(t)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"target",{get:function(){var t;if(this.type==="history"){var e=this.config;C(e.target)?t=gt(e.target)?Ht(this.machine.getStateNodeById(e.target).path.slice(this.path.length-1)):e.target:t=e.target}return t},enumerable:!1,configurable:!0}),n.prototype.getRelativeStateNodes=function(t,e,i){return i===void 0&&(i=!0),i?t.type==="history"?t.resolveHistory(e):t.initialStateNodes:[t]},Object.defineProperty(n.prototype,"initialStateNodes",{get:function(){var t=this;if(Gt(this))return[this];if(this.type==="compound"&&!this.initial)return R||H(!1,"Compound state node '".concat(this.id,"' has no initial state.")),[this];var e=Yt(this.initialStateValue);return j(e.map(function(i){return t.getFromRelativePath(i)}))},enumerable:!1,configurable:!0}),n.prototype.getFromRelativePath=function(t){if(!t.length)return[this];var e=M(t),i=e[0],r=e.slice(1);if(!this.states)throw new Error("Cannot retrieve subPath '".concat(i,"' from node with no states"));var s=this.getStateNode(i);if(s.type==="history")return s.resolveHistory();if(!this.states[i])throw new Error("Child state '".concat(i,"' does not exist on '").concat(this.id,"'"));return this.states[i].getFromRelativePath(r)},n.prototype.historyValue=function(t){if(Object.keys(this.states).length)return{current:t||this.initialStateValue,states:Ce(this.states,function(e,i){if(!t)return e.historyValue();var r=C(t)?void 0:t[i];return e.historyValue(r||e.initialStateValue)},function(e){return!e.history})}},n.prototype.resolveHistory=function(t){var e=this;if(this.type!=="history")return[this];var i=this.parent;if(!t){var r=this.target;return r?j(Yt(r).map(function(o){return i.getFromRelativePath(o)})):i.initialStateNodes}var s=En(i.path,"states")(t).current;return C(s)?[i.getStateNode(s)]:j(Yt(s).map(function(o){return e.history==="deep"?i.getFromRelativePath(o):[i.states[o[0]]]}))},Object.defineProperty(n.prototype,"stateIds",{get:function(){var t=this,e=j(Object.keys(this.states).map(function(i){return t.states[i].stateIds}));return[this.id].concat(e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"events",{get:function(){var t,e,i,r;if(this.__cache.events)return this.__cache.events;var s=this.states,o=new Set(this.ownEvents);if(s)try{for(var a=E(Object.keys(s)),h=a.next();!h.done;h=a.next()){var u=h.value,c=s[u];if(c.states)try{for(var d=(i=void 0,E(c.events)),l=d.next();!l.done;l=d.next()){var v=l.value;o.add("".concat(v))}}catch(y){i={error:y}}finally{try{l&&!l.done&&(r=d.return)&&r.call(d)}finally{if(i)throw i.error}}}}catch(y){t={error:y}}finally{try{h&&!h.done&&(e=a.return)&&e.call(a)}finally{if(t)throw t.error}}return this.__cache.events=Array.from(o)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"ownEvents",{get:function(){var t=new Set(this.transitions.filter(function(e){return!(!e.target&&!e.actions.length&&e.internal)}).map(function(e){return e.eventType}));return Array.from(t)},enumerable:!1,configurable:!0}),n.prototype.resolveTarget=function(t){var e=this;if(t!==void 0)return t.map(function(i){if(!C(i))return i;var r=i[0]===e.delimiter;if(r&&!e.parent)return e.getStateNodeByPath(i.slice(1));var s=r?e.key+i:i;if(e.parent)try{var o=e.parent.getStateNodeByPath(s);return o}catch(a){throw new Error("Invalid transition definition for state node '".concat(e.id,`':
`).concat(a.message))}else return e.getStateNodeByPath(s)})},n.prototype.formatTransition=function(t){var e=this,i=_n(t.target),r="internal"in t?t.internal:i?i.some(function(h){return C(h)&&h[0]===e.delimiter}):!0,s=this.machine.options.guards,o=this.resolveTarget(i),a=f(f({},t),{actions:Q(V(t.actions)),cond:Pe(t.cond,s),target:o,source:this,internal:r,eventType:t.event,toJSON:function(){return f(f({},a),{target:a.target?a.target.map(function(h){return"#".concat(h.id)}):void 0,source:"#".concat(e.id)})}});return a},n.prototype.formatTransitions=function(){var t,e,i=this,r;if(!this.config.on)r=[];else if(Array.isArray(this.config.on))r=this.config.on;else{var s=this.config.on,o=Nt,a=s[o],h=a===void 0?[]:a,u=te(s,[typeof o=="symbol"?o:o+""]);r=j(Object.keys(u).map(function(g){!R&&g===pt&&H(!1,"Empty string transition configs (e.g., `{ on: { '': ... }}`) for transient transitions are deprecated. Specify the transition in the `{ always: ... }` property instead. "+'Please check the `on` configuration for "#'.concat(i.id,'".'));var w=lt(g,u[g]);return R||hi(i,g,w),w}).concat(lt(Nt,h)))}var c=this.config.always?lt("",this.config.always):[],d=this.config.onDone?lt(String(Ot(this.id)),this.config.onDone):[];R||H(!(this.config.onDone&&!this.parent),'Root nodes cannot have an ".onDone" transition. Please check the config of "'.concat(this.id,'".'));var l=j(this.invoke.map(function(g){var w=[];return g.onDone&&w.push.apply(w,P([],M(lt(String(Mt(g.id)),g.onDone)),!1)),g.onError&&w.push.apply(w,P([],M(lt(String(ft(g.id)),g.onError)),!1)),w})),v=this.after,y=j(P(P(P(P([],M(d),!1),M(l),!1),M(r),!1),M(c),!1).map(function(g){return V(g).map(function(w){return i.formatTransition(w)})}));try{for(var p=E(v),S=p.next();!S.done;S=p.next()){var m=S.value;y.push(m)}}catch(g){t={error:g}}finally{try{S&&!S.done&&(e=p.return)&&e.call(p)}finally{if(t)throw t.error}}return y},n}(),en=!1;function ci(n,t){return!R&&!("predictableActionArguments"in n)&&!en&&(en=!0,console.warn("It is highly recommended to set `predictableActionArguments` to `true` when using `createMachine`. https://xstate.js.org/docs/guides/actions.html")),new ui(n,t)}var mt=We,fe=ot;const{choose:li}=Wn,di={rect:{on:{MT_DOWN:{actions:["createRectangle","selectUnfinished"],target:"#drawing.rect.mouseIsDown"}}},circle:{on:{MT_DOWN:{actions:["createCircle","selectUnfinished"],target:"#drawing.circle.mouseIsDown"}}},ellipse:{on:{MT_DOWN:{actions:["createEllipse","selectUnfinished"],target:"#drawing.ellipse.mouseIsDown"}}},polygon:{on:{MT_DOWN:{actions:["createPolygon","selectUnfinished"],target:"#drawing.polygon.mouseIsDown"}}}},fi={rect:{states:{mouseIsDown:{on:{MT_UP:"#idle.drawMode.rect",KEYDOWN_ESC:"#idle.drawMode.rect",MT_MOVE:{actions:"resizeUnfinished"}}}}},circle:{states:{mouseIsDown:{on:{MT_UP:"#idle.drawMode.circle",KEYDOWN_ESC:"#idle.drawMode.circle",MT_MOVE:{actions:"resizeUnfinished"}}}}},ellipse:{states:{mouseIsDown:{on:{MT_UP:"#idle.drawMode.ellipse",KEYDOWN_ESC:"#idle.drawMode.ellipse",MT_MOVE:{actions:"resizeUnfinished"}}}}},polygon:{on:{KEYDOWN_ESC:"#idle.drawMode.polygon"},states:{mouseIsDown:{on:{MT_UP:"mouseIsUp",MT_MOVE:{actions:"moveLastPoint"}}},mouseIsUp:{on:{MT_DOWN:[{cond:"isHandle",target:"#idle.drawMode.polygon"},{actions:"addPoint",target:"mouseIsDown"}]}}}}},vi=n=>ci({context:{unfinishedComponent:void 0,mouseDownInSelectModeObject:void 0,_editor:n},predictableActionArguments:!0,on:{MODE_SELECT:"idle.selectMode",MODE_DRAW_RECT:"idle.drawMode.rect",MODE_DRAW_CIRCLE:"idle.drawMode.circle",MODE_DRAW_ELLIPSE:"idle.drawMode.ellipse",MODE_DRAW_POLYGON:"idle.drawMode.polygon"},initial:"idle",states:{idle:{id:"idle",initial:"selectMode",states:{selectMode:{initial:"mouseIsUp",states:{mouseIsUp:{on:{MT_DOWN:{actions:["selectComponent","mouseDownInSelectModeAssign"],target:"mouseIsDown"},KEYDOWN_ARRAY:{actions:"mouseDownInSelectModeObjectMove"}}},mouseIsDown:{on:{MT_UP:"mouseIsUp",MT_MOVE:{actions:"mouseDownInSelectModeObjectMove"}}}},on:{KEYDOWN_ESC:{actions:["unselectAll",fe("mouseDownInSelectModeUnassign")]},KEYDOWN_DEL:{actions:["deleteComponent",fe("mouseDownInSelectModeUnassign")]},mouseDownInSelectModeUnassign:{actions:"mouseDownInSelectModeUnassign"}},entry:"selectModeEntry",exit:["unselectAll",fe("mouseDownInSelectModeUnassign")]},drawMode:{initial:void 0,states:di,on:{KEYDOWN_ESC:"#idle.selectMode"}}}},drawing:{id:"drawing",initial:void 0,states:fi,exit:li([{cond:"unfinishedIsValid",actions:["unselectAll","validComponentFinished"]},{actions:"discardUnfinished"}])}}},{actions:{createRectangle:mt({unfinishedComponent:(t,e)=>t._editor.createRectangle({x:e.offsetX,y:e.offsetY})}),createCircle:mt({unfinishedComponent:(t,e)=>t._editor.createCircle({x:e.offsetX,y:e.offsetY})}),createEllipse:mt({unfinishedComponent:(t,e)=>t._editor.createEllipse({x:e.offsetX,y:e.offsetY})}),createPolygon:mt({unfinishedComponent:(t,e)=>t._editor.createPolygon({points:{x:e.offsetX,y:e.offsetY}})}),discardUnfinished:(t,e)=>{t._editor.unregisterComponent(t.unfinishedComponent)},resizeUnfinished:(t,e)=>{t.unfinishedComponent.resize(e.offsetX,e.offsetY)},selectUnfinished:(t,e)=>{t._editor.selectComponent(t.unfinishedComponent)},validComponentFinished:(t,e)=>{const i=t.unfinishedComponent;t._editor.componentDrawnHandler&&t._editor.componentDrawnHandler(i,i.element.id)},addPoint:(t,e)=>{t.unfinishedComponent.addPoint(e.offsetX,e.offsetY),t._editor.selectComponent(t.unfinishedComponent)},moveLastPoint:(t,e)=>{t.unfinishedComponent.moveLastPoint(e.offsetX,e.offsetY)},mouseDownInSelectModeAssign:mt({mouseDownInSelectModeObject:(t,e)=>e.component}),mouseDownInSelectModeUnassign:mt({mouseDownInSelectModeObject:null}),mouseDownInSelectModeObjectMove:(t,e)=>{const i=t.mouseDownInSelectModeObject;i&&i.move&&i.move(e.movementX,e.movementY)},selectComponent:(t,e)=>{t._editor.selectComponent(e.component)},deleteComponent:(t,e)=>{const i=t.mouseDownInSelectModeObject;i&&t._editor.unregisterComponent(i)},unselectAll:(t,e)=>{t._editor.selectComponent(null)},selectModeEntry:(t,e)=>{t._editor.mode="select",t._editor.selectModeHandler&&t._editor.selectModeHandler()}},guards:{isHandle:(t,e)=>e.component instanceof $,unfinishedIsValid:(t,e)=>t.unfinishedComponent.isValid()}}),pi=n=>tn(vi(n)),ve=(n,t,e)=>{const i={defineProperty(r,s,o){return Object.is(o.value,r[s])||(typeof t=="function"?t.call(e||this,s,o.value,r[s],n):t[s].call(e||this,o.value,r[s],n)),Reflect.defineProperty(r,s,o)}};return new Proxy(n,i)};function nn(n,t,e){return new $(n,t,(i,r)=>{e.x+=i,e.y+=r},this.isFrozen)}class yi{constructor(t,e){this.includeAttributes=["fill","stroke","opacity","stroke-width"],this.editorOwner=t,this.element=Z.createElementNS(it,"polygon"),this.points=[],this.includeAttributes=["fill","stroke","opacity","stroke-width"],e&&[e].flat().forEach(i=>this.addPoint(i.x,i.y)),this.isSelected=!1,this.isFrozen=!1}freeze(t){return this.isFrozen=t!==void 0?!!t:!0,this.getHandles().forEach(e=>e.freeze(t)),this}updateElementPoints(){return this.element.setAttribute("points",this.points.map(t=>`${t.x},${t.y}`).join(" ")),this}addPoint(t,e){const i={x:t,y:e},r=ve(i,(s,o,a,h)=>{var u,c;s!=="handle"&&(this._logWarnOnOpOnFrozen("Point moved on"),this.updateElementPoints(),(c=(u=h.handle)==null?void 0:u["setAttr"+s.toUpperCase()])==null||c.call(u,o))});return i.handle=nn.call(this,t,e,r),this.editorOwner.registerComponentHandle(i.handle),this.points.push(r),this.updateElementPoints(),this}moveLastPoint(t,e){const i=this.points[this.points.length-1];return[i.x,i.y]=[t,e],this}move(t,e){return this.points.forEach(i=>{i.x+=t,i.y+=e}),this}isValid(){return this.points.length>=3}setHandlesVisibility(t){return this.points.forEach(e=>{var i;if(!e.handle){const r=nn.call(this,e.x,e.y,e);e.handle=r,(i=this.editorOwner)==null||i.registerComponentHandle(r)}e.handle.setVisible(t)}),this}getCenterCoords(){return this.points.reduce((t,e)=>(t.x+=e.x/this.points.length,t.y+=e.y/this.points.length,t),{x:0,y:0})}scale(t){return this.points.forEach((e,i)=>{e.x=Number((e.x*t).toFixed(2)),e.y=Number((e.y*t).toFixed(2))}),this.updateElementPoints(),this}setIsSelected(t){return this._logWarnOnOpOnFrozen("Select/unselect performed on"),this.isSelected=t=t!==void 0?!!t:!0,this.setHandlesVisibility(t),this.style&&X(this.element,t?this.style.componentSelect.on:this.style.componentSelect.off),this}getHandles(){return this.points.map(t=>t.handle)}clearHandles(){this.points.forEach(t=>{var e;(e=this.editorOwner)==null||e.unregisterComponent(t.handle),t.handle=null})}setStyle(t){return this.style=t,X(this.element,t.component),X(this.element,t.componentHover.off),X(this.element,t.componentSelect.off),Qt(this.element,t.componentHover.off,t.componentHover.on),this}setDataAttributes(t){for(let e in t)this.element.setAttribute(e,String(t[e]));return this}export(){const t={points:this.points.map(e=>{var i,r;return{x:Number((e.x/(((i=this.editorOwner)==null?void 0:i.scale)||1)).toFixed(2)),y:Number((e.y/(((r=this.editorOwner)==null?void 0:r.scale)||1)).toFixed(2))}})};for(let e of this.element.attributes)(e.name in this.includeAttributes||me.test(e.name))&&(t[e.name]=e.value);return t}_logWarnOnOpOnFrozen(t){this.isFrozen&&console.warn(`${t} frozen ${this.element.tagName} with id ${this.element.id}`)}}function rn(){const{x:n,y:t,width:e,height:i}=this.dim;this.handles=[new $(n,t,(r,s)=>{this.dim.x+=r,this.dim.width-=r,this.dim.y+=s,this.dim.height-=s},this.isFrozen),new $(n,t+i,(r,s)=>{this.dim.x+=r,this.dim.width-=r,this.dim.height+=s},this.isFrozen),new $(n+e,t,(r,s)=>{this.dim.width+=r,this.dim.y+=s,this.dim.height-=s},this.isFrozen),new $(n+e,t+i,(r,s)=>{this.dim.width+=r,this.dim.height+=s},this.isFrozen)],this.handles.forEach(r=>{var s;(s=this.editorOwner)==null||s.registerComponentHandle(r)})}class pe{constructor(t,e){this.editorOwner=null,this.includeAttributes=["fill","stroke","opacity","stroke-width"],this.dim={x:0,height:0,width:0,y:0},this.handles=[],this.isSelected=!1,this.isFrozen=!1,this.propChangeListener=e,this.svgElementName=t,this.element=Z.createElementNS(it,this.svgElementName)}add(t,e,i,r=0,s=0){this.editorOwner=t,this.dim=ve({x:e,y:i,width:0,height:0},{x:(o,a,h)=>{this._logWarnOnOpOnFrozen("Dimension property x changed on"),this.propChangeListener.x.call(this,o,a,h),this.handles.length&&(this.handles[0].setAttrX(o),this.handles[1].setAttrX(o),this.handles[2].setAttrX(o+h.width),this.handles[3].setAttrX(o+h.width))},y:(o,a,h)=>{this._logWarnOnOpOnFrozen("Dimension property y changed on"),this.propChangeListener.y.call(this,o,a,h),this.handles.length&&(this.handles[0].setAttrY(o),this.handles[1].setAttrY(o+h.height),this.handles[2].setAttrY(o),this.handles[3].setAttrY(o+h.height))},width:(o,a,h)=>{this._logWarnOnOpOnFrozen("Dimension property width changed on"),this.propChangeListener.width.call(this,o,a,h),this.handles.length&&(this.handles[2].setAttrX(h.x+o),this.handles[3].setAttrX(h.x+o))},height:(o,a,h)=>{this._logWarnOnOpOnFrozen("Dimension property height changed on"),this.propChangeListener.height.call(this,o,a,h),this.handles.length&&(this.handles[1].setAttrY(h.y+o),this.handles[3].setAttrY(h.y+o))}},this),rn.call(this),[this.dim.width,this.dim.height]=[r,s],this.isSelected=!1,this.isFrozen=!1}freeze(t){return this.isFrozen=t!==void 0?!!t:!0,this.handles.forEach(e=>e.freeze(t)),this}resize(t,e){return this.dim.width=t-this.dim.x,this.dim.height=e-this.dim.y,this}move(t,e){return this.dim.x+=t,this.dim.y+=e,this}isValid(){return this.dim.width&&this.dim.height}setHandlesVisibility(t){var e,i;return t&&!((e=this.handles)!=null&&e.length)&&rn.call(this),(i=this.handles)==null||i.forEach(r=>r==null?void 0:r.setVisible(t)),this}setIsSelected(t){return this._logWarnOnOpOnFrozen("Select/unselect performed on"),this.isSelected=t=t!==void 0?!!t:!0,this.setHandlesVisibility(t),this.style&&X(this.element,t?this.style.componentSelect.on:this.style.componentSelect.off),this}getHandles(){return this.handles}getCenterCoords(){return{x:this.dim.x+this.dim.width/2,y:this.dim.y+this.dim.height/2}}clearHandles(){this.handles.forEach(t=>{var e;return(e=this.editorOwner)==null?void 0:e.unregisterComponent(t)}),this.handles=[]}scale(t){return this.dim.width=Number((this.dim.width*t).toFixed(2)),this.dim.height=Number((this.dim.height*t).toFixed(2)),this.dim.x=Number((this.dim.x*t).toFixed(2)),this.dim.y=Number((this.dim.y*t).toFixed(2)),this}setStyle(t){return this.style=t,X(this.element,t.component),X(this.element,t.componentHover.off),X(this.element,t.componentSelect.off),Qt(this.element,t.componentHover.off,t.componentHover.on),this}setDataAttributes(t){var e;for(let i in t)(e=this.element)==null||e.setAttribute(i,String(t[i]));return this}export(){var e,i,r,s,o;const t={width:Number((this.dim.width/(((e=this.editorOwner)==null?void 0:e.scale)||1)).toFixed(2)),height:Number((this.dim.height/(((i=this.editorOwner)==null?void 0:i.scale)||1)).toFixed(2)),x:Number((this.dim.x/(((r=this.editorOwner)==null?void 0:r.scale)||1)).toFixed(2)),y:Number((this.dim.y/(((s=this.editorOwner)==null?void 0:s.scale)||1)).toFixed(2))};for(let a of(o=this.element)==null?void 0:o.attributes)(a.name in this.includeAttributes||me.test(a.name))&&(t[a.name]=a.value);return t}_logWarnOnOpOnFrozen(t){var e,i;this.isFrozen&&console.warn(`${t} frozen ${(e=this.element)==null?void 0:e.tagName} with id ${(i=this.element)==null?void 0:i.id}`)}}class gi extends pe{constructor(t,e,i,r,s){super("rect",{x:(o,a,h)=>{this.element.setAttribute("x",String(h.width<0?o+h.width:o))},y:(o,a,h)=>{this.element.setAttribute("y",String(h.height<0?o+h.height:o))},width:(o,a,h)=>{this.element.setAttribute("width",String(Math.abs(o))),this.element.setAttribute("x",String(o<0?h.x+o:h.x))},height:(o,a,h)=>{this.element.setAttribute("height",String(Math.abs(o))),this.element.setAttribute("y",String(o<0?h.y+o:h.y))}}),this.add(t,e,i,r,s)}}class mi extends pe{constructor(t,e,i,r,s){super("circle",{x:(o,a,h)=>{var u;(u=this==null?void 0:this.element)==null||u.setAttribute("cx",String(o+h.width/2))},y:(o,a,h)=>{var u;(u=this==null?void 0:this.element)==null||u.setAttribute("cy",String(o+h.height/2))},width:(o,a,h)=>{var u,c;(u=this==null?void 0:this.element)==null||u.setAttribute("r",String(Math.min(Math.abs(o),Math.abs(h.height))/2)),(c=this==null?void 0:this.element)==null||c.setAttribute("cx",String(h.x+o/2))},height:(o,a,h)=>{var u,c;(u=this==null?void 0:this.element)==null||u.setAttribute("r",String(Math.min(Math.abs(o),Math.abs(h.width))/2)),(c=this==null?void 0:this.element)==null||c.setAttribute("cy",String(h.y+o/2))}}),this.add(t,e,i,r,s)}}class wi extends pe{constructor(t,e,i,r,s){super("ellipse",{x:(o,a,h)=>{this.element.setAttribute("cx",String(o+h.width/2))},y:(o,a,h)=>{this.element.setAttribute("cy",String(o+h.height/2))},width:(o,a,h)=>{this.element.setAttribute("rx",String(Math.abs(o)/2)),this.element.setAttribute("cx",String(h.x+o/2))},height:(o,a,h)=>{this.element.setAttribute("ry",String(Math.abs(o)/2)),this.element.setAttribute("cy",String(h.y+o/2))}}),this.add(t,e,i,r,s)}}var wt=(n=>(n[n.LMB=1]="LMB",n[n.RMB=2]="RMB",n[n.MMB=4]="MMB",n))(wt||{});const Si=new RegExp(/[A-Z]+/g),sn=n=>{const t=n.matchAll(Si);for(let e of t)e.index&&(n=n.replace(e[0],"-"+e[0].toLowerCase()));return n};class ye{constructor(t,e={},i){if(this.scale=1,this.imageSizes={width:0,height:0},this.mouseButtons=[wt.LMB,wt.MMB,wt.RMB],[this.width=1200,this.height=600,this.componentDrawnHandler,this.selectModeHandler,this.clickHandler,this.selectHandler,this.idGenerator,this.deleteHandler,this.onMouseOver,this.onMouseOut]=[e.width,e.height,e.componentDrawnHandler,e.selectModeHandler,e.clickHandler,e.selectHandler,e.idGenerator,e.deleteHandler,e.onMouseOver,e.onMouseOut],e.mouseButtons&&(this.mouseButtons=e.mouseButtons),this.style=Zt(pn(),i),this.fsmService=pi(this).start(),this.svg=t,typeof t=="string"){if(this.svg=Z.getElementById(t),!this.svg){this.svg=Z.createElementNS(it,"svg"),this.svg.setAttribute("version","1.1"),this.svg.setAttribute("id",t),this.svg.setAttribute("width",this.width+"px"),this.svg.setAttribute("height",this.height+"px"),this.svg.setAttribute("viewBox",`0, 0, ${this.width} ${this.height}`),this.svg.setAttribute("preserveAspectRatio","xMinYMin");const r=this.svg;e.isBuilderMode||window.addEventListener("load",function(){Z.body.appendChild(r)},{once:!0})}}else t&&t.tagName==="svg"&&(this.svg=t);if(!this.svg)throw new Error("No SVG element provided");this.cgroup=Z.createElementNS(it,"g"),this.hgroup=Z.createElementNS(it,"g"),this.svg.replaceChildren(this.cgroup,this.hgroup),this._cacheElementMapping=ve({},(r,s,o)=>{s?s instanceof $?this.hgroup.appendChild(s.element):this.cgroup.appendChild(s.element):o instanceof $?this.hgroup.removeChild(o.element):o&&(this.cgroup.removeChild(o.element),o.getHandles().forEach(a=>{this.unregisterComponent(a)}))}),this._idCounter=1,this._handleIdCounter=1}async loadImage(t,e,i){var s;const r=async o=>new Promise((a,h)=>{const u=new XMLHttpRequest;u.onload=function(){const c=new FileReader;c.onloadend=function(){a(c.result)},c.readAsDataURL(u.response)},u.onerror=()=>{h(u.response)},u.open("GET",o),u.responseType="blob",u.send()});try{const o=await r(t);return this.image=Z.createElementNS(it,"image"),this.image.setAttribute("href",o),this.imageSizes.width=e,this.imageSizes.height=i,e&&this.image.setAttribute("width",String(e)),i&&this.image.setAttribute("height",String(i)),(s=this.svg)==null||s.prepend(this.image),this}catch(o){return console.error(o),this}}setStyle(t){return this.style=Zt(this.style,t),this}setScale(t){var i,r;const e=t/this.scale;for(const s in this._cacheElementMapping)(r=(i=this._cacheElementMapping[s])==null?void 0:i.scale)==null||r.call(i,e);if(this.image&&this.image.getAttribute("width")&&this.image.getAttribute("height")){const{width:s,height:o}=this.imageSizes;s&&this.image.setAttribute("width",(s*t).toFixed(2)),o&&this.image.setAttribute("height",(o*t).toFixed(2))}this.scale=t}setEditorMode(t){switch(this.mode=t,t){case"circle":{this.fsmService.send("MODE_DRAW_CIRCLE");break}case"ellipse":{this.fsmService.send("MODE_DRAW_ELLIPSE");break}case"polygon":{this.fsmService.send("MODE_DRAW_POLYGON");break}case"rect":{this.fsmService.send("MODE_DRAW_RECT");break}case"select":{this.fsmService.send("MODE_SELECT");break}}}selectComponent(t){let e;return typeof t=="string"?e=this.getComponentById(t):e=t,(!e||e.setIsSelected)&&Object.values(this._cacheElementMapping).forEach(i=>{var r;i===t&&((r=this.selectHandler)==null||r.call(this,i.element.id,i),i.setIsSelected&&i.setIsSelected(!0)),i!==t&&!i.isFrozen&&i.setIsSelected&&(i.setIsSelected(!1),i.getHandles().forEach(s=>{this.unregisterComponent(s)}),i.clearHandles())}),e}removeComponent(t){return typeof t=="string"&&(t=this.getComponentById(t)),this.unregisterComponent(t),t}on(t,e){return W(this.svg,t,e),this}addFiguresEventListener(t,e){return W(this.cgroup,t,e),this}removeFiguresEventListener(t,e){return we(this.cgroup,t,e),this}off(t,e){return we(this.svg,t,e),this}getComponentById(t){return this._cacheElementMapping&&this._cacheElementMapping[t]}import(t,e){const i=typeof t=="string"?JSON.parse(t):t;return this._idCounter=i.idCounter,i.components.map(r=>{var a,h;const s=e?e(r.id):r.id,o={};for(let u in r.data)o[sn(u)]=r.data[u];switch((h=(a=r.data)==null?void 0:a.entries)==null||h.call(a).map(([u,c])=>({[sn(u)]:c})),r.type){case"rect":return this.createRectangle(o,s);case"circle":return this.createCircle(o,s);case"ellipse":return this.createEllipse(o,s);case"polygon":return this.createPolygon(o,s);default:return console.error("Unknown type",r.type),null}}).filter(r=>{var s;return(s=r==null?void 0:r.clearHandles)==null||s.call(r),!!r})}export(t){return{idCounter:this._idCounter,components:Object.entries(this._cacheElementMapping).filter(([i,r])=>!(r instanceof $)).map(([i,r])=>({id:i,type:r.element.tagName,data:r.export()}))}}exportAsString(){const t=new XMLSerializer().serializeToString(this.svg);return btoa(t)}createRectangle(t,e){const{x:i,y:r,width:s,height:o,...a}=t;return this.registerComponent(new gi(this,i,r,s,o).setStyle(this.style).setDataAttributes(a),e)}createCircle(t,e){const{x:i,y:r,width:s,height:o,...a}=t;return this.registerComponent(new mi(this,i,r,s,o).setStyle(this.style).setDataAttributes(a),e)}createEllipse(t,e){const{x:i,y:r,width:s,height:o,...a}=t;return this.registerComponent(new wi(this,i,r,s,o).setStyle(this.style).setDataAttributes(a),e)}createPolygon(t,e){const{points:i,...r}=t;return this.registerComponent(new yi(this,i).setStyle(this.style).setDataAttributes(r),e)}registerComponent(t,e){var i;return t instanceof $?e="handle_"+this._handleIdCounter++:e=e||((i=this.idGenerator)==null?void 0:i.call(this))||t.element.tagName+"_"+this._idCounter++,this._cacheElementMapping[e]=t,t.element.id=e,t}registerComponentHandle(t){return this.registerComponent(t.setStyle(this.style.handle,this.style.handleHover))}unregisterComponent(t){var e,i,r;t=typeof t=="string"?this.selectComponent(t):t,t&&(!(t instanceof $)&&((e=t.isValid)!=null&&e.call(t))&&((r=this.deleteHandler)==null||r.call(this,(i=t==null?void 0:t.element)==null?void 0:i.id,t)),t._logWarnOnOpOnFrozen&&t._logWarnOnOpOnFrozen("Deleting"),this._cacheElementMapping[t.element.id]=null,delete this._cacheElementMapping[t.element.id])}destroy(){this.svg.remove();for(let t in this)delete this[t]}}const bi=n=>{let t;return W(n.svg,"mousedown touchstart",e=>{var a;if(e.preventDefault(),e instanceof MouseEvent&&!(e.button in n.mouseButtons))return;const i=n.getComponentById(e.target.id),r=i&&i.isFrozen?null:i,s=(a=n.svg)==null?void 0:a.getBoundingClientRect(),o=e.targetTouches&&e.targetTouches[0];n.fsmService.send({type:"MT_DOWN",component:r,offsetX:e.offsetX!==void 0?e.offsetX:o&&o.clientX-s.x,offsetY:e.offsetY!==void 0?e.offsetY:o&&o.clientY-s.y}),t=o}),W(n.svg,"mouseup touchend mouseleave touchleave",e=>{e.preventDefault(),n.fsmService.send({type:"MT_UP"}),t=null}),W(n.svg,"mousemove touchmove",e=>{var s;const i=(s=n.svg)==null?void 0:s.getBoundingClientRect(),r=e.targetTouches&&e.targetTouches[0];n.fsmService.send({type:"MT_MOVE",offsetX:e.offsetX!==void 0?e.offsetX:r&&r.clientX-i.x,offsetY:e.offsetY!==void 0?e.offsetY:r&&r.clientY-i.y,movementX:e.movementX!==void 0?e.movementX:t?r.clientX-t.clientX:0,movementY:e.movementY!==void 0?e.movementY:t?r.clientY-t.clientY:0}),t=r}),W(ht.window,"keydown",e=>{switch(e.key){case"Escape":n.fsmService.send("KEYDOWN_ESC");break;case"Enter":n.fsmService.send("KEYDOWN_ESC");case"Delete":n.fsmService.send("KEYDOWN_DEL");break;case"ArrowUp":e.preventDefault(),n.fsmService.send({type:"KEYDOWN_ARRAY",movementX:0,movementY:-1});break;case"ArrowDown":e.preventDefault(),n.fsmService.send({type:"KEYDOWN_ARRAY",movementX:0,movementY:1});break;case"ArrowLeft":e.preventDefault(),n.fsmService.send({type:"KEYDOWN_ARRAY",movementX:-1,movementY:0});break;case"ArrowRight":e.preventDefault(),n.fsmService.send({type:"KEYDOWN_ARRAY",movementX:1,movementY:0});break}}),n},xi=n=>(W(n.cgroup,"click touchstart",t=>{var e;t.preventDefault(),n.clickHandler&&n.clickHandler(t,t.target.id,(e=n.selectComponent(t.target.id))==null?void 0:e.getCenterCoords())}),W(n.cgroup,"mouseover",t=>{var e,i;t.preventDefault(),(i=n.onMouseOver)==null||i.call(n,t,t.target.id,(e=n.selectComponent(t.target.id))==null?void 0:e.getCenterCoords())}),W(n.cgroup,"mouseout",t=>{var e;t.preventDefault(),(e=n.onMouseOut)==null||e.call(n,t,t.target.id)}),n),Zt=(n,...t)=>{if(!t.length||!t[0])return n;const e=t.shift();return Object.entries(e).forEach(([i,r])=>{Object.getPrototypeOf(r)===Object.prototype?Zt(n[i],r):n[i]=r}),Zt(n,...t)},on=n=>function(e,i={},r){return n?xi(new ye(e,i,r)):bi(new ye(e,i,r))},Ei=n=>"points"in n;class qt{constructor(t,e){if(this.dim={x:0,y:0,width:0,height:0},this.center={x:0,y:0},this.id=e,this.data=t,Ei(t)){const i={t:t.points[0],l:t.points[0],r:t.points[0],b:t.points[0]};t.points.forEach(r=>{r.x<i.l.x&&(i.l=r),r.x>i.r.x&&(i.r=r),r.y<i.t.y&&(i.t=r),r.y>i.b.y&&(i.b=r)}),this.dim={x:i.l.x,y:i.t.y,width:i.r.x-i.l.x,height:i.b.y-i.t.y}}else this.dim={x:t.x,y:t.y,width:t.width,height:t.height};this.center={x:this.dim.x+this.dim.width/2,y:this.dim.y+this.dim.height/2}}}class Oi extends qt{constructor(t,e){super(t,e)}click(t,e){return t>=this.data.x&&t<=this.data.x+this.data.width&&e>=this.data.y&&e<=this.data.y+this.data.height}}class Mi extends qt{constructor(t,e){super(t,e)}click(t,e){const i={x:this.data.x+this.data.width/2,y:this.data.y+this.data.height/2};return Math.pow(t-i.x,2)+Math.pow(e-i.y,2)<Math.pow(this.data.width/2,2)}}class Ai extends qt{constructor(t,e){super(t,e)}click(t,e){const i={x:this.data.x+this.data.width/2,y:this.data.y+this.data.height/2};return Math.pow(t-i.x,2)/Math.pow(this.data.width/2,2)+Math.pow(e-i.y,2)/Math.pow(this.data.height/2,2)<=1}}class Ci extends qt{constructor(t,e){super(t,e)}click(t,e){let i=0,r=0,s=0,o=0,a=0;const h=this.data.points.length;for(let u=1;u<=h;u++)r=this.data.points[u-1].x,s=this.data.points[u-1].y,u==h?(o=this.data.points[0].x,a=this.data.points[0].y):(o=this.data.points[u].x,a=this.data.points[u].y),s<=e?a>e&&this.isLeft(r,s,o,a,t,e)>0&&++i:a<=e&&this.isLeft(r,s,o,a,t,e)<0&&--i;return i!=0}isLeft(t,e,i,r,s,o){return(i-t)*(o-e)-(s-t)*(r-e)}}class Di{constructor(){this.lastClickTime=0,this.DC_trashHold=10}onTouchStart(t,e){this.touchStartPoint={x:t,y:e}}onTouchEnd(t,e){this.lastClickTime=Date.now(),this.touchEndPoint={x:t,y:e}}isClicked(t=0){var e,i,r,s,o,a,h,u;return t&&this.touchStartPoint&&this.touchEndPoint?Math.abs(((e=this.touchStartPoint)==null?void 0:e.x)-((i=this.touchEndPoint)==null?void 0:i.x))<=t&&Math.abs(((r=this.touchStartPoint)==null?void 0:r.y)-((s=this.touchEndPoint)==null?void 0:s.y))<=t:((o=this.touchStartPoint)==null?void 0:o.x)===((a=this.touchEndPoint)==null?void 0:a.x)&&((h=this.touchStartPoint)==null?void 0:h.y)===((u=this.touchEndPoint)==null?void 0:u.y)}isDoubleClicked(){return this.isClicked(this.DC_trashHold)&&Date.now()-this.lastClickTime<300}}class Ti{constructor(t,e={},i="",r){this.scale=1,this.background="",this.alpha=1,this.componentsMap=new Map,this.zonesMap=new Map,this.zonesCount=4,this.getZone=(a,h)=>{const u=this.img.width/this.zonesCount,c=this.img.height/this.zonesCount,d=Math.ceil(a/u),l=Math.ceil(h/c);return d+(l-1)*this.zonesCount-1};const{width:s,height:o}=e;this.clickHandler=e.clickHandler,this.background=i,r&&this.initZones(r),typeof t=="string"?(this.img=new Image,this.img.id=t,this.img.width=s||1200,this.img.height=o||600,window.addEventListener("load",()=>{Z.body.appendChild(this.img)},{once:!0})):this.img=t,this.initEventListeners()}on(t,e){return W(this.img,t,e),this}setScale(t){this.scale=t,this.img.style.transform=`scale(${t*100})`}loadImage(t){this.background=t}async import(t){if(!this.background)throw new Error("Background is not set");let e=new ye("builder",{isBuilderMode:!0,width:this.img.width,height:this.img.height});t.components.forEach(i=>{switch(i.type==="polygon"&&i.data,i.type){case"rect":const r=this.createRectangle(i.data,i.id);this.zonesCount&&this.setToZones(r),this.componentsMap.set(i.id,r);break;case"circle":const s=this.createCircle(i.data,i.id);this.zonesCount&&this.setToZones(s),this.componentsMap.set(i.id,s);break;case"ellipse":const o=this.createEllipse(i.data,i.id);this.zonesCount&&this.setToZones(o),this.componentsMap.set(i.id,o);break;case"polygon":const a=this.createPolygon(i.data,i.id);this.zonesCount&&this.setToZones(a),this.componentsMap.set(i.id,a);break}}),await e.loadImage(this.background,this.img.width,this.img.height).then(()=>{e.import(t);const i=e.exportAsString();this.background="data:image/svg+xml;base64,"+i,this.img.src=this.background})}createRectangle(t,e){return new Oi(t,e)}createCircle(t,e){return new Mi(t,e)}createEllipse(t,e){return new Ai(t,e)}createPolygon(t,e){return new Ci(t,e)}initZones(t){this.zonesCount=Math.ceil(Math.sqrt(t));for(let e=0;e<Math.pow(this.zonesCount,2);e++)this.zonesMap.set(e,new Set)}setToZones(t){let e,i,r,s;const{x:o,y:a,width:h,height:u}=t.dim;e={x:o,y:a},i={x:o+h,y:a},r={x:o+h,y:a+u},s={x:o,y:a+u},[e,i,r,s].forEach(c=>{const d=this.getZone(c.x,c.y),l=this.zonesMap.get(d);l==null||l.add(t)})}initEventListeners(){if(!this.clickHandler)return;const t=new Di;this.img.ontouchstart=e=>{e.preventDefault(),e.stopPropagation(),t.onTouchStart(e.changedTouches[0].clientX,e.changedTouches[0].clientY)},this.img.ontouchend=e=>{if(console.log(t.isDoubleClicked()),t.onTouchEnd(e.changedTouches[0].clientX,e.changedTouches[0].clientY),t.isClicked()){const i=e.changedTouches[0].clientX-this.img.offsetLeft,r=e.changedTouches[0].clientY-this.img.offsetTop,s=this.getZone(i,r),o=this.zonesMap.get(s);o==null||o.forEach(a=>{var h;a.click(i,r)&&((h=this.clickHandler)==null||h.call(this,e,a.id,a.center))})}}}}const an=on(!1),hn=on(!0),_i={editor:an,view:hn,MouseButtons:wt};K.MobileViewer=Ti,K.MouseButtons=wt,K.default=_i,K.editor=an,K.view=hn,Object.defineProperties(K,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
